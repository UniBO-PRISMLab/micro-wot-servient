{% macro updateTD() -%}
{%- for item in td['forms'] if 'href' in item %}
    {%- if loop.index == 2 -%}
    {%- do item.update(href='" + urlSocket + "/all/properties') -%} 
    {%- else -%}
    {%- do item.update(href='" + urlServer + "/all/properties') -%}    
    {%- endif -%}
{%- endfor %}    
{#- EndPoint Properties #}
{%- for property in template['properties'] %}
    {%- set i = loop.index -%}
    {%- for item in td['properties'][property['name']]['forms'] if 'href' in item -%}
        {%- if loop.index == 2 -%}
        {%- do item.update(href='" + urlSocket + "/properties/" + property' + i | string + '_name + "' ) -%}
        {%- else -%}
        {%- do item.update(href='" + urlServer + "/properties/" + property' + i | string + '_name + "' ) -%}
        {%- endif -%}
    {%- endfor -%}
{%- endfor %}
{#- EndPoint Actions #}    
{%- for action in template['actions'] %}
    {%- set i = loop.index -%}
    {%- for item in td['actions'][action['name']]['forms'] if 'href' in item -%}
        {%- if loop.index == 2 -%}
        {%- do item.update(href='" + urlSocket + "/actions/" + action' + i | string + '_name + "' ) -%}
        {%- else -%}
        {%- do item.update(href='" + urlServer + "/actions/" + action' + i | string + '_name + "' ) -%}
        {%- endif -%}
    {%- endfor -%}
{%- endfor %}     
{#- EndPoint Events #}    
{%- for event in template['events'] %}
    {%- set i = loop.index -%}
    {%- for item in td['events'][event['name']]['forms'] if 'href' in item -%}
        {%- do item.update(href='" + urlSocket + "/events/" + event' + i | string + '_name + "' ) -%}
    {%- endfor -%}
{%- endfor %}   
{%- endmacro %}
{%- macro updateGlobal() -%}
{%- do global.update({'isPropertyString':False}) -%}
{%- do global.update({'isPropertyBoolean':False}) -%}
{%- do global.update({'isPropertyInteger':False}) -%}
{%- do global.update({'isPropertyNumber':False}) -%}
{%- do global.update({'isPropertyArray':False}) -%}
{%- do global.update({'isString':False}) -%}
{%- do global.update({'isBoolean':False}) -%}
{%- do global.update({'isInteger':False}) -%}
{%- do global.update({'isNumber':False}) -%}
{%- do global.update({'isMin':False}) -%}
{%- do global.update({'isMax':False}) -%}
{%- do global.update({'isArray':False}) -%}
{%- do global.update({'isMinItems':False}) -%}
{%- do global.update({'isMaxItems':False}) -%}
{%- do global.update({'isArrayObject':False}) -%}
{%- do global.update({'isArrayString':False}) -%}
{%- do global.update({'isArrayBoolean':False}) -%}
{%- do global.update({'isArrayInteger': False}) -%}
{%- do global.update({'isArrayNumber': False}) -%}
{%- do global.update({'isArrayMin':False}) -%}
{%- do global.update({'isArrayMax':False}) -%}
{%- do global.update({'isObject':False}) -%}
{%- do global.update({'isProperty':False}) -%}
{%- do global.update({'isRequired':False}) -%}
{%- do global.update({'isSubscription':False}) -%}
{%- do global.update({'isData':False}) -%}
{%- do global.update({'isCancellation':False}) -%}
{%- do global.update({'isWS':False}) -%}
{%- for property in template['properties'] -%}
{%- if property['type'] == 'object' -%}
{%- if 'properties' in property -%}
{%- for p in property['properties'] -%}
{%- if (p['type'] == 'string' or p['type'] == 'null') and (not(global['isPropertyString'])) -%}
{%- do global.update({'isPropertyString':True}) -%}
{%- elif p['type'] == 'boolean' and not(global['isPropertyBoolean']) -%}
{%- do global.update({'isPropertyBoolean':True}) -%}
{% elif p['type'] == 'integer' and not(global['isPropertyInteger']) -%}
{%- do global.update({'isPropertyInteger':True}) -%}
{% elif p['type'] == 'number' and not(global['isPropertynumber']) -%}
{%- do global.update({'isPropertyNumber':True}) -%}
{%- elif p['type'] == 'array' and not(global['isPropertyArray']) -%}
{%- do global.update({'isPropertyArray':True}) -%}
{%- endif -%}
{%- endfor -%}
{%- endif -%}
{%- endif -%}
{%- endfor -%}
{%- for action in template['actions'] -%}
{%- for item in action['input'] -%}
{%- if (item['type'] == 'string' or item['type'] == 'null') and (not(global['isString'])) -%}
{%- do global.update({'isString':True}) -%}
{%- elif item['type'] == 'boolean' and not(global['isBoolean']) -%}
{%- do global.update({'isBoolean':True}) -%}
{%- elif item['type'] == 'integer' or item['type'] == 'number' -%}
{%- if item['type'] == 'integer' and not(global['isInteger']) -%}
{%- do global.update({'isInteger':True}) -%}
{%- elif item['type'] == 'number' and not(global['isNumber']) -%}
{%- do global.update({'isNumber':True}) -%}
{%- endif -%}
{%- if 'minimum' in item and not(global['isMin']) -%}
{%- do global.update({'isMin':True}) -%}
{% endif -%}
{%- if 'maximum' in item and not(global['isMax']) -%}
{%- do global.update({'isMax':True}) -%}
{%- endif -%}
{%- elif item['type'] == 'array' -%}
{%- if not(global['isArray']) -%}
{%- do global.update({'isArray':True}) -%}
{%- endif -%}
{%- if 'minItems' in item and not(global['isMinItems']) -%}
{%- do global.update({'isMinItems':True}) -%}
{%- endif -%}
{%- if 'maxItems' in item and not(global['isMaxItems']) -%}
{%- do global.update({'isMaxItems':True}) -%}
{%- endif -%}
{%- if item['items']['type'] == 'object' and not(global['isArrayObject']) -%}
{%- do global.update({'isArrayObject':True}) -%}
{%- elif (item['items']['type'] == 'string' or item['items']['type'] == 'null') and (not(global['isArrayString'])) -%}
{%- do global.update({'isArrayString':True}) -%}
{%- elif item['items']['type'] == 'boolean' and not(global['isArrayBoolean']) -%}
{%- do global.update({'isArrayBoolean':True}) -%}
{%- elif item['items']['type'] == 'integer' or item['items']['type'] == 'number' -%}
{%- if item['items']['type'] == 'integer' and not(global['isArrayInteger']) -%}
{%- do global.update({'isArrayInteger':True}) -%}
{%- elif item['items']['type'] == 'number' and not(global['isArrayNumber']) -%}
{%- do global.update({'isArrayNumber':True}) -%}
{%- endif -%}
{%- if 'minimum' in item['items'] and not(global['isArrayMin']) -%}
{%- do global.update({'isArrayMin':True}) -%}
{%- endif -%}
{%- if 'maximum' in item['items'] and not(global['isArrayMax']) -%}
{%- do global.update({'isArrayMax':True}) -%}
{%- endif -%}
{%- endif -%}
{%- elif item['type'] == 'object' -%}
{%- if not(global['isObject']) -%}
{%- do global.update({'isObject':True}) -%}
{%- endif -%}
{%- if 'properties' in item -%}
{%- if not(global['isProperty']) -%}
{%- do global.update({'isProperty':True}) -%}
{%- endif -%}
{%- for p in item['properties'] -%}
{%- if (p['type'] == 'string' or p['type'] == 'null') and (not(global['isString'])) -%}
{%- do global.update({'isString':True}) -%}
{%- elif p['type'] == 'boolean' and not(global['isBoolean']) -%}
{%- do global.update({'isBoolean':True}) -%}
{%- elif p['type'] == 'integer' or p['type'] == 'number' -%}
{%- if p['type'] == 'integer' and not(global['isInteger']) -%}
{%- do global.update({'isInteger':True}) -%}
{%- elif p['type'] == 'number' and not(global['isNumber']) -%}
{%- do global.update({'isNumber':True}) -%}
{%- endif -%}
{%- if 'minimum' in p and not(global['isMin']) -%}
{%- do global.update({'isMin':True}) -%}
{%- endif -%}
{%- if 'maximum' in p and not(global['isMax']) -%}
{%- do global.update({'isMax':True}) -%}
{%- endif -%}
{%- elif p['type'] == 'array' -%}
{%- do global.update({'isArray':True}) -%}
{%- if 'minItems' in p['items'] and not(global['isMinItems']) -%}
{%- do global.update({'isMinItems':True}) -%}
{%- endif -%}
{%- if 'maxItems' in p['items'] and not(global['isMaxItems']) -%}
{%- do global.update({'isMaxItems':True}) -%}
{%- endif -%}
{%- if (p['items']['type'] == 'string' or p['items']['type'] == 'null') and (not(global['isArrayString'])) -%}
{%- do global.update({'isArrayString':True}) -%}
{%- elif p['items']['type'] == 'boolean' and not(global['isArrayBoolean']) -%}
{%- do global.update({'isArrayBoolean':True}) -%}
{%- elif p['items']['type'] == 'integer' or p['items']['type'] == 'number' -%}
{%- if p['items']['type'] == 'integer' and not(global['isArrayInteger']) -%}
{%- do global.update({'isArrayInteger':True}) -%}
{%- elif p['items']['type'] == 'number' and not(global['isArrayNumber']) -%}
{%- do global.update({'isArrayNumber':True}) -%}
{%- endif -%}
{%- if 'minimum' in p['items'] and not(global['isArrayMin']) -%}
{%- do global.update({'isArrayMin':True}) -%}
{%- endif -%}
{%- if 'maximum' in p['items'] and not(global['isArrayMax']) -%}
{%- do global.update({'isArrayMax':True}) -%}
{%- endif -%}
{%- endif -%}
{%- endif -%}
{%- endfor -%}
{%- if 'required' in item and not(global['isRequired']) -%}
{%- do global.update({'isRequired':True}) -%}
{%- endif -%}
{%- endif -%}
{%- endif -%}
{%- endfor -%}
{%- endfor -%}
{%- for event in template['events'] -%}
{%- set dataType = ['subscription', 'data', 'cancellation'] -%}
{%- for data in dataType -%}
{%- if data in event -%}
{% if data == dataType[0] and not(global['isSubscription']) %}
{%- do global.update({'isSubscription':True}) -%}
{% elif data == dataType[1] and not(global['isData']) %}
{%- do global.update({'isData':True}) -%}
{% elif data == dataType[2] and not(global['isCancellation']) %}
{%- do global.update({'isCancellation':True}) -%}
{%- endif -%}
{#
{%- for item in event[data] -%}
{%- if (item['type'] == 'string' or item['type'] == 'null') and not(global['isString']) -%}
{%- do global.update({'isString':True}) -%}
{%- elif item['type'] == 'boolean' and not(global['isBoolean']) -%}
{%- do global.update({'isBoolean':True}) -%}
{%- elif item['type'] == 'integer' or item['type'] == 'number' -%}
{%- if item['type'] == 'integer' and not(global['isInteger']) -%}
{%- do global.update({'isInteger':True}) -%}
{%- elif item['type'] == 'number' and not(global['isNumber']) -%}
{%- do global.update({'isNumber':True}) -%}
{%- endif -%}
{%- if 'minimum' in item and not(global['isMin']) -%}
{%- do global.update({'isMin':True}) -%}
{%- endif -%}
{%- if 'maximum' in item and not(global['isMax']) -%}
{%- do global.update({'isMax':True}) -%}
{%- endif -%}
{%- elif item['type'] == 'array' -%}
{%- if not(global['isArray']) -%}
{%- do global.update({'isString':Array}) -%}
{%- endif -%}
{%- if 'minItems' in item and not(global['isMinItems']) -%}
{%- do global.update({'isMinItems':True}) -%}
{%- endif -%}
{%- if 'maxItems' in item and not(global['isMaxItems']) -%}
{%- do global.update({'isMaxItems':True}) -%}
{%- endif -%}
{%- if item['items']['type'] == 'object' and not(global['isArrayObject']) -%}
{%- do global.update({'isArrayObject':True}) -%}
{%- elif (item['items']['type'] == 'string' or item['items']['type'] == 'null') and (not(global['isArrayString'])) -%}
{%- do global.update({'isArrayString':True}) -%}
{%- elif item['items']['type'] == 'boolean' and not(global['isArrayBoolean']) -%}
{%- do global.update({'isArrayBoolean':True}) -%}
{%- elif item['items']['type'] == 'integer' or item['items']['type'] == 'number' -%}
{%- if item['items']['type'] == 'integer' and not(global['isArrayInteger']) -%}
{%- do global.update({'isArrayInteger':True}) -%}
{%- elif item['items']['type'] == 'number' and not(global['isArrayNumber']) -%}
{%- do global.update({'isArrayNumber':True}) -%}
{%- endif -%}
{%- if 'minimum' in item['items'] and not(global['isArrayMin']) -%}
{%- do global.update({'isArrayMin':True}) -%}
{%- endif -%}
{%- if 'maximum' in item['items'] and not(global['isArrayMax']) -%}
{%- do global.update({'isArrayMax':True}) -%}
{%- endif -%}
{%- endif -%}
{%- elif item['type'] == 'object' -%}
{%- if not(global['isObject']) -%}
{%- do global.update({'isObject':True}) -%}
{%- endif -%}
{%- if 'properties' in item -%}
{%- if not(global['isProperty']) -%}
{%- do global.update({'isProperty':True}) -%}
{%- endif -%}
{%- for p in item['properties'] -%}
{%- if (p['type'] == 'string' or p['type'] == 'null') and (not(global['isString'])) -%}
{%- do global.update({'isString':True}) -%}
{%- elif p['type'] == 'boolean' and not(global['isBoolean']) -%}
{%- do global.update({'isBoolean':True}) -%}
{%- elif p['type'] == 'integer' or p['type'] == 'number' -%}
{%- if p['type'] == 'integer' and not(global['isInteger']) -%}
{%- do global.update({'isInteger':True}) -%}
{%- elif p['type'] == 'number' and not(global['isNumber']) -%}
{%- do global.update({'isNumber':True}) -%}
{%- endif -%}
{%- if 'minimum' in p and not(global['isMin']) -%}
{%- do global.update({'isMin':True}) -%}
{%- endif -%}
{%- if 'maximum' in p and not(global['isMax']) -%}
{%- do global.update({'isMax':True}) -%}
{%- endif -%}
{%- elif p['type'] == 'array' -%}
{%- do global.update({'isArray':True}) -%}
{%- if 'minItems' in p['items'] and not(global['isMinItems']) -%}
{%- do global.update({'isMinItems':True}) -%}
{%- endif -%}
{%- if 'maxItems' in p['items'] and not(global['isMaxItems']) -%}
{%- do global.update({'isMaxItems':True}) -%}
{%- endif -%}
{%- if (p['items']['type'] == 'string' or p['items']['type'] == 'null') and (not(global['isArrayString'])) -%}
{%- do global.update({'isArrayString':True}) -%}
{%- elif p['items']['type'] == 'boolean' and not(global['isArrayBoolean']) -%}
{%- do global.update({'isArrayBoolean':True}) -%}
{%- elif p['items']['type'] == 'integer' or p['items']['type'] == 'number' -%}
{%- if p['items']['type'] == 'integer' and not(global['isArrayInteger']) -%}
{%- do global.update({'isArrayInteger':True}) -%}
{%- elif p['items']['type'] == 'number' and not(global['isArrayNumber']) -%}
{%- do global.update({'isArrayNumber':True}) -%}
{%- endif -%}
{%- if 'minimum' in p['items'] and not(global['isArrayMin']) -%}
{%- do global.update({'isArrayMin':True}) -%}
{%- endif -%}
{%- if 'maximum' in p['items'] and not(global['isArrayMax']) -%}
{%- do global.update({'isArrayMax':True}) -%}
{%- endif -%}
{%- endif -%}
{%- endif -%}
{%- endfor -%}
{%- if 'required' in item and not(global['isRequired']) -%}
{%- do global.update({'isRequired':True}) -%}
{%- endif -%}
{%- endif -%}
{%- endif -%}
{%- endfor -%}
#}
{%- endif -%}
{%- endfor -%}
{%- endfor -%}
{%- if td['forms'] | length == 2 -%}
{%- do global.update({'isWS':True}) -%}
{%- endif -%}
{%- for property in template['properties'] -%}
{%- if td['properties'][property['name']]['forms'] | length == 2 -%}
{%- if not(global['isWS']) -%}
{%- do global.update({'isWS':True}) -%}
{%- endif -%}
{%- endif -%}
{%- endfor -%}
{%- for action in template['action'] -%}
{%- if td['actions'][action['name']]['forms'] | length == 2 -%}
{%- if not(global['isWS']) -%}
{%- do global.update({'isWS':True}) -%}
{%- endif -%}
{%- endif -%}
{%- endfor -%}
{%- endmacro -%}
{% macro defineVariable(typeV, name, value) -%}
{%- if value is iterable and value is not string %}
{{ typeV }} {{ name }} = 
    {%- for elem in value -%}
        {%- if loop.last -%} 
            {{ ' ' + elem }};
        {%- else -%}
            {{ ' ' + elem }}
        {%- endif -%}
    {%- endfor -%}    
{%- elif typeV == 'const char*' or typeV == 'char*' %}
{%- if value == 'iv' -%}
{{ typeV }} {{ name }} = "";
{%- else -%}
{{ typeV }} {{ name }} = "{{ value }}";
{%- endif -%}
{%- elif typeV == 'const char' or typeV == 'char' -%}
{%- if value == 'iv' -%}
{{ typeV }} {{ name }};
{%- else -%}
{{ typeV }} {{ name }} = '{{ value }}';
{%- endif -%}
{%- elif typeV.lower() == 'string' or typeV == 'null' %}
{%- if value == 'iv' -%}
{{ castType(typeV) }} {{ name }} = "";
{%- else -%}
{{ castType(typeV) }} {{ name }} = "{{ value }}";
{%- endif -%}
{%- elif typeV == 'string_nq' -%}
String {{ name }} = {{ value }};
{%- elif typeV == 'char_nq' -%}
const char* {{ name }} = {{ value }};
{%- elif typeV == 'integer' %}
{%- if value == '' -%}
int {{ name }};
{%- elif value == 'iv' -%}
int {{ name }} = 0;    
{%- else -%}    
int {{ name }} = {{ value }};
{%- endif -%}
{%- elif typeV == 'number' %}
{%- if value == '' -%}
double {{ name }};
{%- elif value == 'iv' -%}
double {{ name }} = 0.0;
{%- else -%}
{%- set vs = value | string -%}  
{%- if '.' in vs -%}  
double {{ name }} = {{ value }};
{%- else -%}
double {{ name }} = {{ value }}.0;
{%- endif -%}
{%- endif -%}
{% elif typeV == 'boolean' %}
{%- if value == '' -%}
bool {{ name }};
{%- elif value == 'iv' -%}
bool {{ name }} = false;    
{%- else -%}    
bool {{ name }} = {{ value }};
{%- endif -%}
{% elif typeV == 'array' or typeV == 'JsonArray' %}
{%- if value == 'iv' -%}
JsonArray {{ name }};
{%- else -%}
JsonArray {{ name }} = {{ value }};
{%- endif -%}
{% elif typeV == 'object' or typeV == 'JsonObject' %}
{%- if value == 'iv' -%}
JsonObject {{ name }};
{%- else -%}
JsonObject {{ name }} = {{ value }};
{%- endif -%}
{% else %}
{%- if value == 'iv' -%}
{{ typeV }} {{ name }};
{%- else -%}
{{ typeV }} {{ name }} = {{ value }};     
{%- endif -%}
{%- endif %}    
{%- endmacro %}
{% macro setVariable(ifString, name, value='') -%}
{%- if ifString -%}
{{ name }} = "{{ value }}";
{%- elif value == '' -%}
{{ name }};
{%- else -%}
{{ name }} = {{ value }};
{%- endif -%}
{%- endmacro %}
{% macro defineFunction(name, input, output, body, source, cast) -%}
{%- if 'type' in output -%}
{%- if cast -%}
{{ castType(output['type']) }}
{%- else -%}
{{ output['type'] }}
{%- endif -%}
{%- else -%}      
void       
{%- endif -%}        
{{ ' ' + name }}(
    {%- for item in input -%}
        {%- if cast -%}
        {{ castType(item['type']) }}
        {%- else -%}
        {{ item['type'] }}
        {%- endif -%}
        {%- if loop.last -%}      
        {{ ' ' + item['name'] }}
        {%- else -%} 
        {{ ' ' + item['name'] }},
        {%- endif -%}
    {%- endfor -%}
) {
    {% if source == 'cli' %}
{{ '\t' + body | replace('{', '\n\t{\n\t') | replace('}', '}\n\t') | replace(';', ';\n\t') }}
}
    {% else %}
{{ body }}
    {% endif %}
{%- endmacro %}
{% macro castType(type) -%}
{%- if type == 'integer' -%}
int
{%- elif type == 'number' -%}
double
{%- elif type.lower() == 'string' or type == 'null' -%}
String
{%- elif type == 'boolean' -%}
bool
{%- elif type == 'array' -%}
JsonArray
{%- elif type == 'object' -%}
JsonObject 
{%- endif -%}
{%- endmacro %}
{% macro handleInputType(interaction, interactionName, array=False) -%}
{% if interaction['type'] == 'array' %}
{{ defineVariable('JsonArray', interactionName + '_value', 'iv') }}
{% if 'minItems' in property %}
{{ defineVariable('int', interactionName + '_minItems', interaction['minItems']) }}
{% endif %}
{% if 'maxItems' in interaction %}
{{ defineVariable('int', interactionName + '_minItems', interaction['maxItems']) }}
{%- endif %}
{{ handleInputType(interaction['items'], interactionName, True) }}
{% elif interaction['type'] == 'object' %}
{{ defineVariable('JsonObject', interactionName + '_value', 'iv') }}
{% if 'properties' in interaction %}
{{ defineVariable('String', interactionName + '_schema', interaction['properties'] | replace("'", '\\"') | replace(': ', ':') | replace(', ', ',')) }}
{%- endif %}
{% if 'required' in interaction %}
String {{ interactionName }}_opRequired[{{ interaction['required'] | length }}] = {
    {%- for p in interaction['required'] -%}
    {%- if loop.last -%}
    "{{ p }}"
    {%- else -%}
    "{{ p }}",
    {%- endif -%}
    {%- endfor -%}
};
{%- endif -%}
{% elif interaction['type'] == 'integer' or interaction['type'] == 'number' %}
{{ defineVariable(interaction['type'], interactionName + '_value', 'iv') }}
{% if array %}
{% if 'minimum' in interaction %}
{{ defineVariable(interaction['type'], interactionName + '_itemsMinimum', interaction['minimum']) }}
{% endif %}
{% if 'maximum' in interaction %}
{{ defineVariable(interaction['type'], interactionName + '_itemsMaximum', interaction['maximum']) }}
{% endif %}
{% else %}
{% if 'minimum' in interaction %}
{{ defineVariable(interaction['type'], interactionName + '_minimum', interaction['minimum']) }}
{% endif %}
{% if 'maximum' in interaction %}
{{ defineVariable(interaction['type'], interactionName + '_maximum', interaction['maximum']) }}
{%- endif %}
{% endif %}
{% else %}
{{ defineVariable(interaction['type'], interactionName + '_value', 'iv') }}
{% endif %}
{% endmacro -%}
{{ updateTD() }}
{%- set global = {} -%}
{{ updateGlobal() }}
{%- set ssid = template['ssid'] -%}
{%- set password = template['password'] -%}
{%- set protocolServer = 'http' -%}
{%- set protocolSocket = 'ws' -%}
{%- set portServer = template['portserver'] -%}
{%- set portSocket = template['portsocket'] -%}
{%- set ipServer = '192.168.1.5' -%}
{%- set thingName = td['title'].lower() %}
{%- set urlServer = protocolServer + "://" + ipServer + ":" + portServer + "/" + thingName -%}
{%- set thingD = td | replace("'", '\\"') | replace('True', 'true') | replace('False', 'false') | replace(': ', ':') | replace(', ', ',') | replace(' + ', '+') -%}
{%- set req = [] -%}
{%- set dataType = ['subscription', 'data', 'cancellation'] -%}
{%- set capacity = {} -%}
{%- do capacity.update({'maxSchema':20}) -%}
{%- do capacity.update({'maxInputSchema':0}) -%}
#include <ESP8266WebServer.h>
#include <WebSocketsServer.h>
#include <ArduinoJson.h>
{% if template['libraries'] | length > 0 %}
{% for lib in template['libraries'] %}
#include <{{ lib }}>
{% endfor %}
{% endif %}

{% for const in template['constants'] %}
#define {{ const['name'] }} {{ const['value'] }}
{% if loop.last %}

{% endif %}
{% endfor %}
{{ defineVariable('const char*', 'ssid', ssid) }}
{{ defineVariable('const char*', 'password', password) }}
{{ defineVariable('String', 'protocolServer', protocolServer) }}
{{ defineVariable('int', 'portServer', portServer) }}
{{ defineVariable('String', 'urlServer', '') }}
{% if template['numevents'] != 0 or global['isWS'] %}
{{ defineVariable('String', 'protocolSocket', protocolSocket) }}
{{ defineVariable('int', 'portSocket', portSocket) }}
{{ defineVariable('String', 'urlSocket', '') }}
{% endif %}

{{ defineVariable('String', 'thingName', thingName) }}
{{ defineVariable('String', 'td', '') }}

{% if template['numop'] > 0 %}
DynamicJsonDocument p_doc(
    {%- do capacity.update({'properties':0}) -%}
    {%- if global['isPropertyArray'] -%}
    {%- do capacity.update({'properties': 2000}) -%}
    {%- endif -%}
    {%- for property in template['properties'] -%}
    {%- if property['type'] == 'object' -%}
    {%- if 'properties' in property -%}
    {%- do capacity.update({'properties': capacity['properties'] + property['properties'] | length * 200}) -%}
    {%- else -%}
    {%- do capacity.update({'properties': capacity['properties'] + 500}) -%}
    {%- endif -%}
    {%- endif -%}
    {%- endfor -%}
    {{ capacity['properties'] }});
{% endif %}
{% if global['isWS'] %}
// document to handle Interaction Affordances WebSocket requests
DynamicJsonDocument ia_doc(
    {%- do capacity.update({'actions':0}) -%}
    {%- for action in template['actions'] -%}
    {%- if td['actions'][action['name']]['forms'] | length == 2 -%}
    {%- do capacity.update({'actions' : capacity['actions'] + 1}) -%}
    {%- endif -%}
    {%- endfor -%}
    {{ capacity['actions'] * 1000 }});
// document to store the ip addresses of clients connected to WebSocket channel for Interaction Affordances requests   
DynamicJsonDocument ipia_doc(2000);
JsonArray ipia_arr;
{% endif %}
{% if template['numevents'] > 0 %}
// document to handle Events WebSocket requests
DynamicJsonDocument e_doc({{ template['numevents'] * 1000 }});
{% if global['isSubscription'] or global['isData'] or global['isCancellation'] -%}
// document to handle Events Schemas
DynamicJsonDocument es_doc(
    {%- do capacity.update({'events':0}) -%}
    {%- for event in template['events'] -%}
    {%- for data in dataType -%}
    {%- if data in event -%}
    {%- do capacity.update({'events': capacity['events'] + event[data] | string | length}) -%}
    {%- if event[data] | string | length > capacity['maxSchema'] -%}
    {%- do capacity.update({'maxSchema': event[data] | string | length}) -%}
    {%- endif -%}
    {%- endif -%}
    {%- endfor -%}
    {%- endfor -%}
    {{ capacity['events'] * 2 }});
{% else %}
DynamicJsonDocument es_doc(20);
{% endif %}
// document to store the ip addresses of clients connected to WebSocket channel for Events requests   
DynamicJsonDocument ipe_doc(2000);
JsonArray ipe_arr;
{% endif %}
DeserializationError err;

{{ defineVariable('int', 'properties_number', template['numproperties']) }}
{{ defineVariable('int', 'objectProperties_number', template['numop']) }}
{{ defineVariable('int', 'actions_number', template['numactions']) }}
{{ defineVariable('int', 'events_number', template['numevents']) }}

{% if template['numproperties'] > 0 %}
// Properties
{% for property in template['properties'] %}
{{ defineVariable('const char*', 'property' + loop.index | string + '_name', property['name']) }}
{{ handleInputType(property, 'property' + loop.index | string) }}
{% endfor %}
{% endif %}

{% if template['numactions'] > 0 %}
// Actions
{% for action in template['actions'] %}
{% set actionIndex = 'action' + loop.index | string -%}
{{ defineVariable('const char*', actionIndex + '_name', action['name']) }}
{{ defineVariable('int', actionIndex + '_inputsNumber', action['input'] | length) }}
String {{ actionIndex + '_schema' }}[{{ action['input'] | length }}] = {
    {%- for item in action['input'] -%}
    {%- if loop.last -%}
    "{{ item | replace("'", '\\"') | replace(': ', ':') | replace(', ', ',') }}"
    {%- else -%}
    "{{ item | replace("'", '\\"') | replace(': ', ':') | replace(', ', ',') }}",
    {%- endif -%}
    {%- endfor -%}
};
{% if action['input'] | length > 0 %}
{% if action['input'] | string | length > capacity['maxInputSchema'] %}
{% do capacity.update({'maxInputSchema': action['input'] | string | length }) %}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}

{% if template['numevents'] > 0 %}
// Events
{% for event in template['events'] %}
{% set eventIndex = 'event' + loop.index | string -%}
{{ defineVariable('const char*', eventIndex + '_name', event['name']) }}
{% for data in dataType %}
{% if data in event %}
String {{ eventIndex + '_' + data + 'Schema' }}[{{ event[data] | length }}] = {
    {%- for item in event[data] -%}
    {%- if loop.last -%}
    "{{ item | replace("'", '\\"') | replace(': ', ':') | replace(', ', ',') }}"
    {%- else -%}
    "{{ item | replace("'", '\\"') | replace(': ', ':') | replace(', ', ',') }}",
    {%- endif -%}
    {%- endfor -%}
};
{% endif %}
{% endfor %}
{% endfor %}
bool events_subscriptionSchema[{{ template['numevents'] }}] = {
    {%- for event in template['events'] -%}
    {% if dataType[0] in event %}
    {%- if loop.last -%}
    true
    {%- else -%}
    true, 
    {%- endif -%}
    {%- else -%}
    {%- if loop.last -%}
    false
    {%- else -%}
    false, 
    {%- endif -%}
    {%- endif -%}
    {%- endfor -%}
};
bool events_dataSchema[{{ template['numevents'] }}] = {
    {%- for event in template['events'] -%}
    {% if dataType[1] in event %}
    {%- if loop.last -%}
    true
    {%- else -%}
    true, 
    {%- endif -%}
    {%- else -%}
    {%- if loop.last -%}
    false
    {%- else -%}
    false, 
    {%- endif -%}
    {%- endif -%}
    {%- endfor -%}
};
bool events_cancellationSchema[{{ template['numevents'] }}] = {
    {%- for event in template['events'] -%}
    {% if dataType[2] in event %}
    {%- if loop.last -%}
    true
    {%- else -%}
    true, 
    {%- endif -%}
    {%- else -%}
    {%- if loop.last -%}
    false
    {%- else -%}
    false, 
    {%- endif -%}
    {%- endif -%}
    {%- endfor -%}
};
String events_list[{{ template['numevents'] }}] = {
    {%- for i in range(1, template['numevents']+1) -%}
    {%- if i == loop.last -%}
    {{ 'event' + i | string + '_name' }}
    {%- else -%}
    {{ 'event' + i | string + '_name' }},
    {%- endif -%}
    {%- endfor -%}
};
String events_endpoint[{{ template['numevents'] }}] = {
    {%- for i in range(1, template['numevents']+1) -%}
    {%- if i == loop.last -%}
    {{ '"/" + thingName + "/events/" + event' + i | string + '_name' }}
    {%- else -%}
    {{ '"/" + thingName + "/events/" + event' + i | string + '_name' }},
    {%- endif -%}
    {%- endfor -%}
};
{% endif %}

// Requests
{{ defineVariable('String', 'req1', '/') }}
{% do req.append(('req1', 'HTTP_GET')) %}
{{ defineVariable('String', 'req2', ['"/"', '+', 'thingName']) }}
{% do req.append(('req2', 'HTTP_GET')) %}
{{ defineVariable('String', 'req3', ['"/"', '+', 'thingName', '+', '"/all/properties"' ]) }}
{% do req.append(('req3', 'HTTP_GET')) %}
{% for i in range(1, template['numproperties']+1) %}
{% set request = 'req' + (i + 3) | string %}
{{ defineVariable('String', request, ['"/"', '+', 'thingName', '+', '"/properties/"', '+', 'property' + i | string + '_name']) }}
{% do req.append((request, 'HTTP_GET')) %}
{% endfor %}
{% for i in range(1, template['numactions']+1) %}
{% set request = 'req' + (i + 3 + template['numproperties']) | string %}
{{ defineVariable('String', request, ['"/"', '+', 'thingName', '+', '"/actions/"', '+', 'action' + i | string + '_name']) }}
{% do req.append((request, 'HTTP_POST')) %}
{% endfor %}
{% for i in range(1, template['numactions']+1) %}
{% set request = 'req' + (i + 3 + template['numproperties']) | string %}
{% do req.append((request, 'HTTP_GET')) %}
{% endfor %}
{% if global['isWS'] %}
{% set reqWS = [] %}
{% set reqPropertyWS = [] %}
{% if td['forms'] | length == 2 %}
{% do reqWS.append(('thingName', 3)) %}
{% do reqPropertyWS.append(('thingName', 3)) %}
{% endif %}
{% for property in template['properties'] %}
{% if td['properties'][property['name']]['forms'] | length == 2 %}
{% do reqWS.append(('property' + loop.index | string + '_name', loop.index+3)) %}
{% do reqPropertyWS.append(('property' + loop.index | string + '_name', loop.index+3)) %}
{% endif %}
{% endfor %}
{% for action in template['actions'] %}
{% if td['actions'][action['name']]['forms'] | length == 2 %}
{% do reqWS.append(('action' + loop.index | string + '_name', loop.index+3+template['numproperties'])) %}
{% endif %}
{% endfor %}

{{ defineVariable('int', 'ws_requestsNumber', reqWS | length) }}
{{ defineVariable('int', 'ws_actionsNumber', capacity['actions']) }}
String ws_requests[{{ reqWS | length }}] = {
    {%- for i in reqWS -%}
    {%- if loop.last  -%}
    {{ reqWS[loop.index0][0] }}
    {%- else -%}
    {{ reqWS[loop.index0][0] }},
    {%- endif -%}
    {%- endfor -%}
};
String ws_endpoint[{{ reqWS | length }}] = {
    {%- for i in reqWS -%}
    {%- if loop.last  -%}
    req{{ reqWS[loop.index0][1] }}
    {%- else -%}
    req{{ reqWS[loop.index0][1] }},
    {%- endif -%}
    {%- endfor -%}
}; 
{% if template['numactions'] > 0 %}
String ws_actions[{{ capacity['actions'] }}] = {
    {%- for action in template['actions'] -%}
    {%- if td['actions'][action['name']]['forms'] | length == 2 -%}
    {%- if loop.last -%}
    action{{ loop.index }}_name
    {%- else -%}
    action{{ loop.index }}_name,
    {%- endif -%}
    {%- endif -%}
    {%- endfor -%}
};
{% endif %}
{% endif %}

ESP8266WebServer server(portServer);
{% if template['numevents'] != 0 or global['isWS'] %}
WebSocketsServer webSocket = WebSocketsServer(portSocket);
{% endif %}

IPAddress ipS;

{% for var in template['globals'] %}
{% set i = loop.index %}
{% if not(var['isArray']) %}
{% if 'value' in var %}
{{ defineVariable(var['type'], var['name'], var['value']) }}
{% else %}
{{ defineVariable(var['type'], var['name'], 'iv') }}
{% endif %}
{% else %}
{% if var['items'] | length > 0 %}
{{ var['type'] }} {{ var['name'] }}[{{ var['itemsNumber'] }}] = {
    {%- for item in var['items'] -%}
    {%- if loop.last -%}
    {%- if var['type'] == 'String' or var['type'] == 'char*' or var['type'] == 'const char*' -%}
    "{{ item }}"
    {%- elif var['type'] == 'char' -%}
    '{{ item }}'
    {%- else -%}
    {{ item }}
    {%- endif -%}
    {%- else -%}
    {%- if var['type'] == 'String' or var['type'] == 'char*' or var['type'] == 'const char*' -%}
    "{{ item }}",
    {%- elif var['type'] == 'char' -%}
    '{{ item }}',
    {%- else -%}
    {{ item }},
    {%- endif -%}
    {%- endif -%}
    {%- endfor -%}
};
{% else %}
{{ var['type'] }} {{ var['name'] }}[{{ var['itemsNumber'] }}] = {};
{% endif %}
{% endif %}
{% endfor %}

int i, j, k, n;

void setup() {
    Serial.begin(115200);
    Serial.println();
    {% if template['numop'] > 0 %}

    // properties data 
    {% for property in template['properties'] %}
    {% if property['type'] == 'object' %}
    {% set capacity = 0 %}
    {% if 'properties' in property %}
    {% set capacity = property['properties'] | string | length %}
    {% endif %}
    DynamicJsonDocument op{{ loop.index }}_doc({{ capacity*2 }});
    JsonArray arr{{ loop.index }};
    {% endif %}
    {% endfor %}
    {% for property in template['properties'] %}
    {% if property['type'] == 'object' %}

    {{ setVariable(False, 'deserializeJson(op' + loop.index | string + '_doc, property' + loop.index | string + '_schema)') }}
    {{ setVariable(False, 'arr' + loop.index | string, 'op' + loop.index | string + '_doc.as<JsonArray>()') }}
    {{ setVariable(False, 'property' + loop.index | string + '_value', 'p_doc.createNestedObject()') }}
    {% if 'properties' in property %}
    for(i=0; i<arr{{ loop.index }}.size(); i++) {
        {{ defineVariable('string_nq', 'op' + loop.index | string + '_name', 'arr' + loop.index | string + '[i]["name"]') }}
        {{ defineVariable('string_nq', 'op' + loop.index | string + '_type', 'arr' + loop.index | string + '[i]["type"]') }}
        {% if global['isPropertyString'] %}
        if(op{{ loop.index }}_type.equals("string") || op{{ loop.index }}_type.equals("null"))
            {{ setVariable(True, 'property' + loop.index | string + '_value[op' + loop.index | string + '_name]', '') }}
        {% endif -%}
        {% if global['isPropertyBoolean'] %}
        {% if global['isPropertyString'] %}{{ '\t\t\t\telse if' }}{% else %}{{ '\t\t\t\tif' }}{% endif %}(op{{ loop.index }}_type.equals("boolean"))
            {{ setVariable(False, 'property' + loop.index | string + '_value[op' + loop.index | string + '_name]', 'false') }}
        {% endif -%}
        {% if global['isPropertyInteger'] %}
        {% if global['isPropertyString'] or global['isPropertyBooelan'] %}{{ '\t\t\t\telse if' }}{% else %}{{ '\t\t\t\tif' }}{% endif %}(op{{ loop.index }}_type.equals("integer") || op{{ loop.index }}_type.equals("number"))
            {{ setVariable(False, 'property' + loop.index | string + '_value[op' + loop.index | string + '_name]', '0') }}
        {% endif -%}   
        {% if global['isPropertyArray'] %}
        {% if global['isPropertyString'] or global['isPropertyBooelan'] or global['isPropertyInteger'] %}{{ '\t\t\t\telse if' }}{% else %}{{ '\t\t\t\tif' }}{% endif %}(op{{ loop.index }}_type.equals("array"))
            {{ setVariable(False, 'property' + loop.index | string + '_value[op' + loop.index | string + '_name]', 'p_doc.createNestedArray()') }}
        {% endif -%}   
    {{ '\t\t}' }}
    {% endif %}
    {% endif %}
    {% endfor %}
    {% endif %}
    {% if template['numevents'] > 0 %}

    // events data
    {# Il documento es_doc mi serve per parsare correttamente i messaggi nel canale websocket #}
    {% if global['isSubscription'] or global['isData'] or global['isCancellation'] %}
    {{ defineVariable('int', 'schema_size', '0') }}
    JsonArray arr;
    JsonObject obj;
    {% for event in template['events'] %}
    {% set e = loop.index %}
    {% for data in dataType %}
    {% if data in event %}

    {% if e == 1 %}
    {{ setVariable(False, 'schema_size', 'sizeof(event' + e | string + '_' + data + 'Schema) / sizeof(String)') }}
    {% endif %}
    if(es_doc[event{{ e }}_name].isNull())
        {{ setVariable(False, 'arr', 'es_doc.createNestedObject(event' + e | string + '_name).createNestedArray("' + data + '")') }}
    else
        {{ setVariable(False, 'arr', 'es_doc[event' + e | string + '_name].createNestedArray("' + data + '")') }}
    for(i=0; i<schema_size; i++) {
        DynamicJsonDocument tmp_doc({{ capacity['maxSchema'] * 2 }});
        {{ setVariable(False, 'deserializeJson(tmp_doc, event' + e | string + '_' + data + 'Schema[i])') }}
        {{ defineVariable('JsonObject', 'obj', 'arr.createNestedObject()') }}
        {{ setVariable(False, 'obj["name"]', 'tmp_doc["name"]') }}
        {{ setVariable(False, 'obj["value"]', 'tmp_doc["value"]') }}
    }
    {% endif %}
    {% endfor %}
    {% endfor %}
    {% endif %}

    {{ setVariable(False, 'ipe_arr', 'ipe_doc.createNestedArray("clients_list")') }}
    {% endif %}
    {% if global['isWS'] %}
    {{ setVariable(False, 'ipia_arr', 'ipia_doc.createNestedArray("clients_list")') }}
    {% endif %}
  
    connection(ssid, password);
    
    td = "{{ thingD }}";

    // Server requests
    {% for r in req %}
    server.on({{ r[0] }},{{ r[1] }},{{ 'handleReq' + loop.index | string }});
    {% endfor %}

    server.begin();
    {% if template['numevents'] != 0 or global['isWS'] %}
    webSocket.begin();
    webSocket.onEvent(webSocketEvent);
    {% endif %}

    Serial.println("Server started");
    Serial.println(urlServer);
    {% if 'setup' in template %}

    {{ template['setup'] | replace('{', '\n\t{\n\t') | replace('}', '}\n\t') | replace(';', ';\n\t') }}
    {% endif %}
}    

void loop() {
    {% if 'loop' in template %}
    {{ template['loop'] | replace('{', '\n\t{\n\t') | replace('}', '}\n\t') | replace(';', ';\n\t') }}
    {% endif %}

    // handle Requests
    {% if template['numevents'] != 0 or global['isWS'] %}
    webSocket.loop();
    {% endif %}
    server.handleClient();
}

void connection(const char* ssid, const char* password) {
    WiFi.begin(ssid, password);
    
    Serial.print("\nConnecting to ");
    Serial.print(ssid);

    while (WiFi.status() != WL_CONNECTED) {
        delay(1000);
        Serial.print(".");
    }

    Serial.println("\nConnected");
    Serial.print("IP address: ");
    ipS = WiFi.localIP();
    Serial.println(ipS);

    urlServer = protocolServer + "://" + ipS.toString() + ":" + portServer + "/" + thingName;
    {% if template['numevents'] != 0 or global['isWS'] %}
    urlSocket = protocolSocket + "://" + ipS.toString() + ":" + portSocket + "/" + thingName;
    {% endif %}
}

// Request functions
void handleReq1() {
    {{ defineVariable('String', 'resp', 'iv') }}

    Serial.println("\nGET Thing URL");
    {{ setVariable(True, 'resp', '[\\"" + urlServer + "\\"]') }}
    server.send(200, "application/ld+json", resp);
}

void handleReq2() {
    Serial.println("\nGET Thing Description"); 
    server.send(200, "application/ld+json", td);
}

void handleReq3() {
    {{ defineVariable('String', 'resp', 'iv') }}

    {{ setVariable(False, 'resp', 'request3()') }}
    server.send(200, "application/ld+json", resp);
}

{# HandleReq for Properties #}
{% for property in template['properties'] %}
{% set i = loop.index %}
{% set n = i+3 %}
void handleReq{{ n }}() {
    {{ defineVariable('String', 'resp', '') }}
    
    {{ setVariable(False, 'resp', 'request' + n | string + '()') }}
    server.send(200, "application/ld+json", resp);
}

{% endfor -%}

{# HandleReq for Actions #}
{% for action in template['actions'] %}
{%- set a = loop.index -%}
{% set n = a+3+template['numproperties'] %}
void handleReq{{ n }}() {
    {{ defineVariable('String', 'resp', '') }}
    String body = server.arg("plain");
    
    {{ setVariable(False, 'resp', 'request' + n | string + '(body)') }}
    server.send(200, "application/ld+json", resp);
}
{% endfor %}

{% for action in template['actions'] %}
{%- set a = loop.index -%}
void handleReq{{ a+3+template['numproperties']+template['numactions'] }}() {
    {{ defineVariable('char*', 'resp', 'Method Not Allowed') }}
    server.send(405, "text/plain", resp);
}
{% endfor %}

{# functions for property and actions used for HTTP Requests and WebSocket #}
String request3() {
    {% do capacity.update({'nump':0}) %}
    {% for property in template['properties'] %}
    {% if property['type'] != 'object' and property['type'] != 'array' %}
    {% do capacity.update({'nump': capacity['nump'] + 1}) %}
    {% endif %}
    {% endfor %}
    DynamicJsonDocument tmp(
        {%- if 'properties' in capacity -%}
        {{ capacity['properties'] + capacity['nump'] * 200 + 20 }}
        {%- else -%}
        {{ capacity['nump'] * 200 + 20 }}
        {%- endif -%});
    {{ defineVariable('String', 'resp', 'iv') }}
    {{ defineVariable('JsonObject', 'obj', 'tmp.createNestedObject()') }}

    Serial.println("\nGET all properties");
    {% for i in range(1, template['numproperties']+1) %}
    {{ setVariable(False, 'obj[property' + i | string + '_name]', 'property' + i | string + '_value') }}
    {% endfor %}
    {{ setVariable(False, 'serializeJson(obj, resp)') }}

    return resp;
}

{% for property in template['properties'] %}
{% set i = loop.index %}
String request{{ i+3 }}() {
    {{ defineVariable('String', 'resp', '') }}
    {% if property['type'] == 'object' or property['type'] == 'array' %}
    {{ defineVariable('String', 'tmp', '') }}
    {% endif %}

    Serial.printf("\nGET %s value\n", property{{ i }}_name);
    {% if property['type'] == 'object' or property['type'] == 'array' %}
    {{ setVariable(False, 'serializeJson(property' + i | string + '_value, tmp)') }}
    {{ setVariable(True, 'resp', '{\\"" + (String) property' + i | string + '_name + "\\":" + tmp + "}') }}
    {% else %}
    {{ setVariable(True, 'resp', '{\\"" + (String) property' + i | string + '_name + "\\":" + property' + i | string + '_value + "}') }}
    {% endif %}
    
    return resp;
}

{% endfor -%}

{% for action in template['actions'] %}
{%- set a = loop.index -%}
String request{{ a+3+template['numproperties'] }}(String body) {
    DynamicJsonDocument resp_doc(
        {%- if action['input'] | length > 0 -%}
        {{ action['input'] | length * 200 }}
        {%- else -%}
        20        
        {%- endif -%});
    {{ defineVariable('String', 'resp', 'iv') }}

    Serial.printf("\nPOST invokeaction %s\n", action{{ a }}_name);
    Serial.printf("Body received: %s\n", body.c_str());
    
    {{ setVariable(False, 'err', 'deserializeJson(resp_doc, body)') }}
    if(err) {
        Serial.printf("deserializeJson() failed with code %s", err.c_str());
        {{ setVariable(False, 'resp', 'err.c_str()') }}
        return resp;
    }
    else {
        {% if action['input'] | length > 0 %}
        if(
        {%- for item in action['input'] -%}
        resp_doc["{{ item['name'] }}"].isNull() 
        {%- if not(loop.last) -%}
        {{ ' || ' }}
        {%- endif -%}
        {%- endfor -%}
        )
            {{ setVariable(True, 'resp', 'InvalidInput') }}
        else {
            {{ defineVariable('bool', 'validInput', 'true') }}
            {{ defineVariable('String', 'value', 'iv') }}

            {{ defineVariable('string_nq', 'action' + a | string + '_input[' + action['input'] | length | string + ']', '{}') }}    
            {% for item in action['input'] %}
            {{ defineVariable(item['type'], 'action' + a | string + '_input' + loop.index | string + '_value', 'iv') }}
            {% endfor %}

            {{ setVariable(False, 'i', 0) }}
            while(validInput and i<{{ 'action' + a | string + '_inputsNumber'}}) {
                switch(i) {
                    {% for item in action['input'] %}
                    case {{ loop.index0 }}: {
                        {{ setVariable(True, 'value', '') }}
                        {{ setVariable(False, 'serializeJson(resp_doc["' + item['name'] + '"], value)') }}
                        {{ setVariable(False, 'action' + a | string + '_input[' + loop.index0 | string + ']', 'value') }}
                        {% if global['isArray'] %}
                        {{ setVariable(False, 'validInput', 'handleInputType(value,action' + a | string + '_schema[' + loop.index0 | string + '],false)') }}
                        {% else %}
                        {{ setVariable(False, 'validInput', 'handleInputType(value,action' + a | string + '_schema[' + loop.index0 | string + '])') }}
                        {% endif %}
                    }
                    break;

                    {% endfor %}
                }
                {{ setVariable(False, 'i++') }}
            }    

            if(validInput) {
                {% for item in action['input'] %}
                {% if item['type'] == 'array' or item['type'] == 'object' %}
                DynamicJsonDocument input{{ loop.index }}_doc(
                    {%- if 'properties' in item -%}
                    {{ item['properties'] | length * 200 }}
                    {%- else -%}
                    500
                    {%- endif -%});
                {% endif %}
                {% endfor %}

                {% for item in action['input'] %}
                {% if item['type'] == 'integer' %}
                {{ setVariable(False, 'action' + a | string + '_input' + loop.index | string + '_value', 'action' + a | string + '_input[' + loop.index0 | string + '].toInt()') }}
                {% elif item['type'] == 'number' %}
                {{ setVariable(False, 'action' + a | string + '_input' + loop.index | string + '_value', 'action' + a | string + '_input[' + loop.index0 | string + '].toDouble()') }}
                {% elif item['type'] == 'boolean' %}
                if(action{{ a }}_input[{{ loop.index0 }}].equals("true")) {
                    {{ setVariable(False, 'action' + a | string + '_input' + loop.index | string + '_value', 'true') }}
                }
                else { 
                    {{ setVariable(False, 'action' + a | string + '_input' + loop.index | string + '_value', 'false') }}
                }
                {% elif item['type'] == 'string'%}
                {{ setVariable(False, 'action' + a | string + '_input' + loop.index | string + '_value', 'action' + a | string + '_input[' + loop.index0 | string + ']') }}
                {% elif item['type'] == 'null' %}
                {{ setVariable(False, 'serializeJson(resp_doc["' + item['name'] + '"], action' + a | string +'_input' + loop.index | string +'_value)') }}
                {% elif item['type'] == 'array' %}
                {{ setVariable(False, 'deserializeJson(input' + loop.index | string  + '_doc, action' + a | string + '_input[' + loop.index0 | string + '])') }}
                {{ setVariable(False, 'action' + a | string + '_input' + loop.index | string + '_value', 'input' + loop.index | string  + '_doc.as<JsonArray>()') }}
                {% elif item['type'] == 'object' %}
                {{ setVariable(False, 'deserializeJson(input' + loop.index | string  + '_doc, action' + a | string + '_input[' + loop.index0 | string + '])') }}
                {{ setVariable(False, 'action' + a | string + '_input' + loop.index | string + '_value', 'input' + loop.index | string + '_doc.as<JsonObject>()') }}
                {% endif %}
                {% endfor %}

                {% if 'type' in action['output'] %}
                {{ castType(action['output']['type']) }} output = {{ action['name'] }}(
                {%- for item in action['input'] -%}
                {%- if loop.last -%}
                action{{ a }}_input{{ loop.index }}_value
                {%- else -%}
                action{{ a }}_input{{ loop.index }}_value,
                {%- endif -%}
                {%- endfor -%}
                );   
                {%- else %}
                {{ action['name'] }}(
                    {%- for item in action['input'] -%}
                    {%- if loop.last -%}
                    action{{ a }}_input{{ loop.index }}_value
                    {%- else -%}
                    action{{ a }}_input{{ loop.index }}_value,
                    {%- endif -%}
                    {%- endfor -%}
                ); 
                {% endif %}
                {% if 'type' in action['output'] %}    
                {% if action['output']['type'] != 'string' or action['output']['type'] != 'null' %}
                {{ setVariable(False, 'resp', '(String) output') }}
                {% else %}
                {{ setVariable(False, 'resp', 'output') }}
                {% endif %}
                {% else %}
                {{ setVariable(True, 'resp', '') }}
                {% endif %}
                {% if template['numevents'] > 0 %}
                {% for event in template['events'] %}
                {% set enum = loop.index %}
                {% for ae in event['actions'] %}
                {% if ae == action['name'] %}

                // {{ event['name'] }} condition
                {{ defineVariable('String', 'ws_msg', 'iv') }}
                {% if global['isData'] %}
                {{ defineVariable('String', 't_name', 'iv') }}
                DynamicJsonDocument tmp_doc(
                    {%- if 'data' in event -%}
                    {{ event['data'] | string | length * 2 }}
                    {%- else -%}
                    20
                    {%- endif -%});
                {{ defineVariable('JsonObject', 'tmp_obj', 'tmp_doc.createNestedObject()') }}

                if(events_dataSchema[{{ enum }}]) {
                    for(i=0; i<es_doc[event{{ enum }}_name]["data"].size(); i++) {
                        {{ setVariable(False, 't_name', '""') }}
                        {{ setVariable(False, 'serializeJson(es_doc[event' + enum | string + '_name]["data"][i]["name"], t_name)') }}
                        {{ setVariable(False, 't_name.replace("\\"", "")') }}
                        {{ setVariable(False, 'tmp_obj[t_name]', 'es_doc[event' + enum | string + '_name]["data"][i]["value"]') }}
                    }
                    {{ setVariable(False, 'serializeJson(tmp_obj, ws_msg)') }}
                }
                {% endif %}
                if({{ event['condition'] }}) {
                    for(i=0; i<ipe_arr.size(); i++) {
                        {{ defineVariable('string_nq', 'ws_ip', 'ipe_arr[i]["ip"]') }}
                        {{ defineVariable('JsonArray', 'ae', 'e_doc[ws_ip]') }}
                        for(j=0; j<ae.size(); j++) {
                            if(!ae[j][event{{ enum }}_name].isNull() && ae[j][event{{ enum }}_name]) {
                                {{ defineVariable('unsigned char', 'ws_num', 'ipe_doc[ws_ip]') }}
                                webSocket.sendTXT(ws_num, ws_msg);
                            }
                        }
                    }
                }
                {% endif %}
                {% endfor %}
                {% endfor %}
                {% endif %}
            }
            else
                {{ setVariable(True, 'resp', 'InvalidInput') }}
        }
        {% else %}
        {% if 'type' in action['output'] %}
            {{ castType(action['output']['type']) }} output = {{ action['name'] }}();
        {%- else %}
        {{ action['name'] }}(); 
        {% endif %}
        {% if 'type' in action['output'] %}    
        {% if action['output']['type'] != 'string' or action['output']['type'] != 'null' %}
        {{ setVariable(False, 'resp', '(String) output') }}
        {% else %}
        {{ setVariable(False, 'resp', 'output') }}
        {% endif %}
        {% else %}
        {{ setVariable(True, 'resp', '') }}
        {% endif %}
        {% if template['numevents'] > 0 %}
        {% for event in template['events'] %}
        {% set enum = loop.index %}
        {% for ae in event['actions'] %}
        {% if ae == action['name'] %}
        // {{ event['name'] }} condition
        {{ defineVariable('String', 'ws_msg', 'iv') }}
        {% if global['isData'] %}
        {{ defineVariable('String', 't_name', 'iv') }}
        DynamicJsonDocument tmp_doc(
            {%- if 'data' in event -%}
            {{ event['data'] | string | length * 2 }}
            {%- else -%}
            20
            {%- endif -%});
        {{ defineVariable('JsonObject', 'tmp_obj', 'tmp_doc.createNestedObject()') }}

        if(events_dataSchema[{{ enum }}]) {
            for(i=0; i<es_doc[event{{ enum }}_name]["data"].size(); i++) {
                {{ setVariable(False, 't_name', '""') }}
                {{ setVariable(False, 'serializeJson(es_doc[event' + enum | string + '_name]["data"][i]["name"], t_name)') }}
                {{ setVariable(False, 't_name.replace("\\"", "")') }}
                {{ setVariable(False, 'tmp_obj[t_name]', 'es_doc[event' + enum | string + '_name]["data"][i]["value"]') }}
            }
            {{ setVariable(False, 'serializeJson(tmp_obj, ws_msg)') }}
        }
        {% endif %}
        if({{ event['condition'] }}) {
            for(i=0; i<ipe_arr.size(); i++) {
                {{ defineVariable('string_nq', 'ws_ip', 'ipe_arr[i]["ip"]') }}
                {{ defineVariable('JsonArray', 'ae', 'e_doc[ws_ip]') }}
                for(j=0; j<ae.size(); j++) {
                    if(!ae[j][event{{ enum }}_name].isNull() && ae[j][event{{ enum }}_name]) {
                        {{ defineVariable('unsigned char', 'ws_num', 'ipe_doc[ws_ip]') }}
                        webSocket.sendTXT(ws_num, ws_msg);
                    }
                }
            }
        }
        {% endif %}
        {% endfor %}
        {% endfor %}
        {% endif %}
        {% endif %}
    }
    return resp;
}
{% endfor %}

{% if template['numactions'] > 0 %}
// handle Input Types
{% if global['isArray'] -%}
bool handleInputType(String value, String schema, bool array) {
{% else %}
bool handleInputType(String value, String schema) {   
{% endif -%}     
    {{ '\t' }}DynamicJsonDocument schema_doc(
        {%- do capacity.update({'maxInput':20}) -%}
        {%- do capacity.update({'maxInputObj':0}) -%}
        {%- for action in template['actions'] -%}
        {%- if 'input' in action -%}
        {%- for item in action['input'] -%}
        {%- if item['type'] == 'object' -%}
        {%- if 'properties' in item -%}
        {%- set dim1 = action['input'] | length * 200 + item['properties'] | length * 200 -%}
        {%- set dim2 = item['properties'] | length * 200 -%}
        {%- if dim1 > capacity['maxInput'] -%}
        {%- do capacity.update({'maxInput': dim1}) -%}
        {%- endif -%}
        {%- if dim2 > capacity['maxInputObj'] -%}
        {%- do capacity.update({'maxInputObj': dim2}) -%}
        {%- endif -%}
        {%- else -%}
        {%- set dim1 = action['input'] | length * 200 + 500 -%}
        {%- set dim2 = 500 -%}
        {%- if dim1 > capacity['maxInput'] -%}
        {%- do capacity.update({'maxInput': dim1}) -%}
        {%- endif -%}
        {%- if dim2 > capacity['maxInputObj'] -%}
        {%- do capacity.update({'maxInputObj': dim2}) -%}
        {%- endif -%}
        {%- endif -%}
        {%- elif item['type'] == 'array' -%}
        {%- set dim1 = action['input'] | length * 200 + 2000 -%}
        {%- set dim2 = 2000 -%}
        {%- if dim1 > capacity['maxInput'] -%}
        {%- do capacity.update({'maxInput': dim1}) -%}
        {%- endif -%}
        {%- if dim2 > capacity['maxInputObj'] -%}
        {%- do capacity.update({'maxInputObj': dim2}) -%}
        {%- endif -%}
        {%- else -%}
        {%- set dim1 = action['input'] | length * 200 -%}
        {%- if dim1 > capacity['maxInput'] -%}
        {%- do capacity.update({'maxInput': dim1}) -%}
        {%- endif -%}
        {%- endif -%}
        {%- endfor -%}
        {%- endif -%}
        {%- endfor -%}
        {{ capacity['maxInput'] }});
    {% if global['isArray'] or global['isObject'] %}
    DynamicJsonDocument value_doc({{ capacity['maxInputObj'] }});
    {% endif %}
    {% if global['isArray'] %}
    {{ defineVariable('JsonArray', 'array_value', 'iv') }}
    {% endif %}
    {% if global['isObject'] %}
    {{ defineVariable('JsonObject', 'obj_value', 'iv') }}
    {{ defineVariable('String', 'p', '') }}
    {% endif %}
    {{ defineVariable('bool', 'validInput', 'true') }}

    {{ setVariable(False, 'deserializeJson(schema_doc, schema)') }}
    {{ defineVariable('JsonObject', 'obj_schema', 'schema_doc.as<JsonObject>()') }}
    {{ defineVariable('string_nq', 'type', 'obj_schema["type"]') }}
    
    if(value[0] == '"')
        {{ setVariable(False, 'value.remove(0)') }}
    if(value[value.length()-1] == '"')    
        {{ setVariable(False, 'value.remove(value.length()-1)') }}
    
    {% if global['isString'] or global['isArrayString'] %}
    if(type.equals("string")) {
        {% if global['isArrayString'] %}
        if(array) {
            {{ setVariable(False, 'deserializeJson(value_doc, value)') }}
            {{ setVariable(False, 'array_value', 'value_doc.as<JsonArray>()') }}
            for(i=0; i<array_value.size(); i++) {
                {{ defineVariable('string_nq', 'ae', 'array_value[i]') }}
                if(ae.equalsIgnoreCase("null")) {
                    {{ setVariable(False, 'validInput', 'false') }}
                    break;
                }
            }   
        }
        else if(value.equalsIgnoreCase("null")) 
            {{ setVariable(False, 'validInput', 'false') }}
        {% else %}
        if(value.equalsIgnoreCase("null")) 
            {{ setVariable(False, 'validInput', 'false') }}
        {% endif %}    
    }
    {% endif %}
    {% if global['isBoolean'] or global['isArrayBoolean'] %}
    {% if global['isString'] or global['isArrayString'] %}{{ '\t\telse if' }}{% else %}{{ '\t\tif' }}{% endif %}(type.equals("boolean")) {
        {% if global['isArrayBoolean'] %}
        if(array) {
            {{ setVariable(False, 'deserializeJson(value_doc, value)') }}
            {{ setVariable(False, 'array_value', 'value_doc.as<JsonArray>()') }}
            for(i=0; i<array_value.size(); i++) {
                {{ defineVariable('string_nq', 'ae', 'array_value[i]') }}
                if(!ae.equals("true") && !ae.equals("false")) {
                    {{ setVariable(False, 'validInput', 'false') }}
                    break;
                }
            }
        }
        else if(!value.equals("true") && !value.equals("false"))
            {{ setVariable(False, 'validInput', 'false') }}
        {% else %}   
    if(!value.equals("true") && !value.equals("false"))
        {{ setVariable(False, 'validInput', 'false') }}
        {%- endif %} 
    }
    {% endif %}
    {% if global['isInteger'] or global['isNumber'] or global['isArrayInteger'] or global['isArrayNumber'] %}
    {% if global['isString'] or global['isArrayString'] or global['isBoolean'] or global['isArrayBoolean'] %}{{ '\t\telse if' }}{% else %}{{ '\t\tif' }}{% endif %}(type.equals("integer") || type.equals("number")) {
        {% if global['isArrayInteger'] or global['isArrayNumber'] %}
        if(array) {
            {{ setVariable(False, 'deserializeJson(value_doc, value)') }}
            {{ setVariable(False, 'array_value', 'value_doc.as<JsonArray>()') }}
            for(i=0; i<array_value.size(); i++) {
                {{ defineVariable('string_nq', 'ae', 'array_value[i]') }}
                {{ defineVariable('int', 'dot_count', '0') }}
                {{ setVariable(False, 'j', 0) }}
                while(validInput && j<ae.length()) { 
                    if(!isDigit(ae[j])) 
                        {{ setVariable(False, 'validInput', 'false') }}  
                    else if(ae[j] == '.')
                        if(j == 0 || j == ae.length()-1 || dot_count > 1)
                            {{ setVariable(False, 'validInput', 'false') }}
                        else 
                            {{ setVariable(False, 'dot_count++') }}    
                    {{ setVariable(False, 'j++') }}    
                }
                if(!validInput)   
                    break; 
            }
            {% if global['isArrayMin'] or global['isArrayMax'] %}
            if(validInput) {
                {{ defineVariable('int', 'input[array_value.size()]', '{}') }}
                for(i=0; i<array_value.size(); i++) 
                    if(type.equals("integer"))
                        {{ setVariable(False, 'input[i]', 'array_value[i].toInt()') }}
                    else 
                        {{ setVariable(False, 'input[i]', 'array_value[i].toDouble()') }}    
                {% if global['isArrayMin'] %}
                if(!obj_schema["minimum"].isNull()) 
                    for(i=0; i<array_value.size(); i++)
                        if(input[i] < obj_schema["minimum"]) {
                            {{ setVariable(False, 'validInput', 'false') }}
                            break;
                        }
                {% endif %}
                {% if global['isArrayMax'] %}        
                if(!obj_schema["maximum"].isNull())  
                    for(i=0; i<array_value.size(); i++)
                        if(input[i] > obj_schema["maximum"]) {
                            {{ setVariable(False, 'validInput', 'false') }}
                            break;
                        }   
                {% endif %}          
            }
            {% endif %}       
        }
        else {
            {{ defineVariable('int', 'dot_count', '0') }}
            {{ setVariable(False, 'i', 0) }}
            while(validInput && i<value.length()) {
                if(!isDigit(value[i])) 
                    {{ setVariable(False, 'validInput', 'false') }}
                else if(value[i] == '.')
                    if(i == 0 || i == value.length()-1 || (dot_count > 1)
                        {{ setVariable(False, 'validInput', 'false') }}
                    else 
                        {{ setVariable(False, 'dot_count++') }}    
                {{ setVariable(False, 'i++') }}          
            } 
            {% if global['isMin'] or global['isMax'] %}
            if(validInput) {
                {{ defineVariable('double', 'input', 'value.toDouble()') }} 
                {% if global['isMin'] %}
                if(!obj_schema["minimum"].isNull()) 
                    if(input < obj_schema["minimum"])
                        {{ setVariable(False, 'validInput', 'false') }}
                {% endif %}
                {% if global['isMax'] %}        
                if(!obj_schema["maximum"].isNull())  
                    if(input > obj_schema["maximum"])
                        {{ setVariable(False, 'validInput', 'false') }}     
                {% endif %}          
            }
            {% endif %}
        }
        {% else %}
        {{ defineVariable('int', 'dot_count', '0') }}
        {{ setVariable(False, 'i', 0) }}
        while(validInput && i<value.length()) {
            if(!isDigit(value[i])) 
                {{ setVariable(False, 'validInput', 'false') }}
            else if(value[i] == '.')
                if(i == 0 || i == value.length()-1 || dot_count > 1)
                    {{ setVariable(False, 'validInput', 'false') }}
                else 
                    {{ setVariable(False, 'dot_count++') }}    
            {{ setVariable(False, 'i++') }}          
        } 
        {% if global['isMin'] or global['isMax'] %}
        if(validInput) {
            {{ defineVariable('double', 'input', 'value.toDouble()') }} 
            {% if global['isMin'] %}
            if(!obj_schema["minimum"].isNull()) 
                if(input < obj_schema["minimum"])
                    {{ setVariable(False, 'validInput', 'false') }}
            {% endif %}
            {% if global['isMax'] %}        
            if(!obj_schema["maximum"].isNull())  
                if(input > obj_schema["maximum"])
                    {{ setVariable(False, 'validInput', 'false') }}     
            {% endif %}          
        }
        {% endif %}
        {% endif %}
    }
    {% endif %}
    {% if global['isArray']  %}
    {% if global['isString'] or global['isArrayString'] or global['isBoolean'] or global['isArrayBoolean'] or global['isInteger'] or global['isArrayInteger'] or global['isNumber'] or global['isArrayNumber'] %}{{ '\t\telse if' }}{% else %}{{ '\t\tif' }}{% endif %}(type.equals("array")) {
        {{ setVariable(False, 'deserializeJson(value_doc, value)') }}
        {{ setVariable(False, 'array_value', 'value_doc.as<JsonArray>()') }}
        if(array_value.isNull()) 
            {{ setVariable(False, 'validInput', 'false') }}
        else {
            {% if global['isMinItems'] %}
            if(!obj.schema["minItems"].isNull())
                if(array_value.size() < obj.schema["minItems"])    
                    {{ setVariable(False, 'validInput', 'false') }}
            {% endif %}
            {% if global['isMaxItems'] %}
            if(!obj.schema["maxItems"].isNull())
                if(array_value.size() > obj.schema["maxItems"])    
                    {{ setVariable(False, 'validInput', 'false') }}
            {% endif %}
            {% if global['isMinItems'] or global['isMaxItems'] %}
            if(validInput) {
                {{ setVariable(True, 'schema', '') }}
                {{ setVariable(False, 'serializeJson(obj_schema["items"], schema)') }}
                {{ setVariable(False, 'validInput', 'handleInputType(value, schema, true)') }}
            }
            {% else %}
            {{ setVariable(True, 'schema', '') }}
            {{ setVariable(False, 'serializeJson(obj_schema["items"], schema)') }}
            {{ setVariable(False, 'validInput', 'handleInputType(value, schema, true)') }}
            {% endif %}
        }
    }
    {% endif %}
    {% if global['isObject'] or global['isArrayObject'] %}
    {% if global['isArrayObject'] and global['isProperty'] %}
    {% if global['isString'] or global['isArrayString'] or global['isBoolean'] or global['isArrayBoolean'] or global['isInteger'] or global['isArrayInteger'] or global['isNumber'] or global['isArrayNumber'] or global['isArray'] %}{{ '\t\telse if' }}{% else %}{{ '\t\tif' }}{% endif %}(type.equals("object")) {
        if(array) {
            {{ setVariable(False, 'deserializeJson(value_doc, value)') }}
            {{ setVariable(False, 'array_value', 'value_doc.as<JsonArray>()') }}
            for(i=0; i<array_value.size(); i++) {
                {% if global['isRequired'] %}
                for(j=0; j<obj_schema["required"].size(); j++) {
                    {{ setVariable(False, 'p', 'iv') }}
                    {{ setVariable(False, 'serializeJson(obj_schema["required"][j], p)') }}
                    {{ setVariable(False, 'p.replace("\\"", "")') }}
                    if(array_value[i][p].isNull()) {
                        {{ setVariable(False, 'validInput', 'false') }}
                        break;
                    }
                }
                if(validInput) {
                    for(j=0; i<obj_schema["properties"].size(); j++) {
                        {{ setVariable(False, 'p', 'iv') }}
                        {{ setVariable(False, 'serializeJson(obj_schema["properties"][j]["name"], p)') }}
                        {{ setVariable(False, 'p.replace("\\"", "")') }}
                        if(!array_value[i][p].isNull()) {
                            {{ setVariable(True, 'schema', '') }}
                            {{ setVariable(True, 'value', '') }}
                            {{ setVariable(False, 'serializeJson(obj_schema["properties"][j], schema)') }}
                            {{ setVariable(False, 'serializeJson(array_value[i][p], value)') }}
                            {% if global['isArray'] %}
                            {{ setVariable(False, 'validInput', 'handleInputType(value, schema, false)') }} 
                            {% else %}
                            {{ setVariable(False, 'validInput', 'handleInputType(value, schema)') }} 
                            {% endif %}
                        }
                    }
                }
                else
                    break;    
                {% else %}
                for(j=0; j<obj_schema["properties"].size(); j++) {
                    {{ setVariable(False, 'p', 'iv') }}
                    {{ setVariable(False, 'serializeJson(obj_schema["properties"][j]["name"], p)') }}
                    {{ setVariable(False, 'p.replace("\\"", "")') }}
                    if(!array_value[i][p].isNull()) {
                        {{ setVariable(True, 'schema', '') }}
                        {{ setVariable(True, 'value', '') }}
                        {{ setVariable(False, 'serializeJson(obj_schema["properties"][j], schema)') }}
                        {{ setVariable(False, 'serializeJson(array_value[i][p], value)') }}
                        {% if global['isArray'] %}
                        {{ setVariable(False, 'validInput', 'handleInputType(value, schema, false)') }} 
                        {% else %}
                        {{ setVariable(False, 'validInput', 'handleInputType(value, schema)') }} 
                        {% endif %}
                    }
                }
                {% endif %}
            }
        }
        else {
            {{ setVariable(False, 'deserializeJson(value_doc, value)') }}
            {{ setVariable(False, 'obj_value', 'value_doc.as<JsonObject>()') }}
            if(obj_value.isNull())
                {{ setVariable(False, 'validInput', 'false') }}
            {% if global['isProperty'] %}
            else {
                {% if global['isRequired'] %}
                for(i=0; i<obj_schema["required"].size(); i++) {
                    {{ setVariable(False, 'p', 'iv') }}
                    {{ setVariable(False, 'serializeJson(obj_schema["required"][i], p)') }}
                    {{ setVariable(False, 'p.replace("\\"", "")') }}
                    if(obj_value[p].isNull()) {
                        {{ setVariable(False, 'validInput', 'false') }}
                        break;
                    }
                }
                if(validInput) {
                    for(i=0; i<obj_schema["properties"].size(); i++) {
                        {{ setVariable(True, 'p', '') }}
                        {{ setVariable(False, 'serializeJson(obj_schema["properties"][i]["name"], p)') }}
                        {{ setVariable(False, 'p.replace("\\"", "")') }}
                        if(!obj_value[p].isNull()) {
                            {{ setVariable(True, 'schema', '') }}
                            {{ setVariable(True, 'value', '') }}
                            {{ setVariable(False, 'serializeJson(obj_schema["properties"][i], schema)') }}
                            {{ setVariable(False, 'serializeJson(obj_value[p], value)') }}
                            {% if global['isArray'] %}
                            {{ setVariable(False, 'validInput', 'handleInputType(value, schema, false)') }} 
                            {% else %}
                            {{ setVariable(False, 'validInput', 'handleInputType(value, schema)') }} 
                            {% endif %}
                        }
                    }
                }
                {% else %}
                for(i=0; i<obj_schema["properties"].size(); i++) {
                    {{ setVariable(True, 'p', '') }}
                    {{ setVariable(False, 'serializeJson(obj_schema["properties"][i]["name"], p)') }}
                    {{ setVariable(False, 'p.replace("\\"", "")') }}
                    if(!obj_value[p].isNull()) {
                        {{ setVariable(True, 'schema', '') }}
                        {{ setVariable(True, 'value', '') }}
                        {{ setVariable(False, 'serializeJson(obj_schema["properties"][i], schema)') }}
                        {{ setVariable(False, 'serializeJson(obj_value[p], value)') }}
                        {% if global['isArray'] %}
                        {{ setVariable(False, 'validInput', 'handleInputType(value, schema, false)') }} 
                        {% else %}
                        {{ setVariable(False, 'validInput', 'handleInputType(value, schema)') }} 
                        {% endif %}
                    }
                }
                {% endif %}
            }
            {% endif %}
        }
    }
    {% elif not(global['isArrayObject']) %}
    else if(type.equals("object")) {
        {{ setVariable(False, 'deserializeJson(value_doc, value)') }}
        {{ setVariable(False, 'obj_value', 'value_doc.as<JsonObject>()') }}
        if(obj_value.isNull())
            {{ setVariable(False, 'validInput', 'false') }}
        {% if global['isProperty'] %}
        else {
            {% if global['isRequired'] %}
            for(i=0; i<obj_schema["required"].size(); i++) {
                {{ setVariable(True, 'p', '') }}
                {{ setVariable(False, 'serializeJson(obj_schema["required"][i], p)') }}
                {{ setVariable(False, 'p.replace("\\"", "")') }}
                if(obj_value[p].isNull()) {
                    {{ setVariable(False, 'validInput', 'false') }}
                    break;
                }
            }
            if(validInput) {
                for(i=0; i<obj_schema["properties"].size(); i++) {
                    {{ setVariable(True, 'p', '') }}
                    {{ setVariable(False, 'serializeJson(obj_schema["properties"][i]["name"], p)') }}
                    {{ setVariable(False, 'p.replace("\\"", "")') }}
                    if(!obj_value[p].isNull()) {
                        {{ setVariable(True, 'schema', '') }}
                        {{ setVariable(True, 'value', '') }}
                        {{ setVariable(False, 'serializeJson(obj_schema["properties"][i], schema)') }}
                        {{ setVariable(False, 'serializeJson(obj_value[p], value)') }}
                        {% if global['isArray'] %}
                        {{ setVariable(False, 'validInput', 'handleInputType(value, schema, false)') }} 
                        {% else %}
                        {{ setVariable(False, 'validInput', 'handleInputType(value, schema)') }} 
                        {% endif %}
                    }
                }
            }
            {% else %}
            for(i=0; i<obj_schema["properties"].size(); i++) {
                {{ setVariable(True, 'p', '') }}
                {{ setVariable(False, 'serializeJson(obj_schema["properties"][i]["name"], p)') }}
                {{ setVariable(False, 'p.replace("\\"", "")') }}
                if(!obj_value[p].isNull()) {
                    {{ setVariable(True, 'schema', '') }}
                    {{ setVariable(True, 'value', '') }}
                    {{ setVariable(False, 'serializeJson(obj_schema["properties"][i], schema)') }}
                    {{ setVariable(False, 'serializeJson(obj_value[p], value)') }}
                    {% if global['isArray'] %}
                    {{ setVariable(False, 'validInput', 'handleInputType(value, schema, false)') }} 
                    {% else %}
                    {{ setVariable(False, 'validInput', 'handleInputType(value, schema)') }} 
                    {% endif %}
                }
            }
            {% endif %}
        }
        {% endif %}  
    }
    {% endif %}
    {% endif %}
    return validInput;
}

// Action functions
{% for action in template['actions'] %}
{{ defineFunction(action['name'], action['input'], action['output'], action['body'], action['source'], True) }}
{% endfor %}
{% endif %}

{# Events #}
{% if template['numevents'] > 0 or global['isWS'] %}
// handle Events
void webSocketEvent(uint8_t num, WStype_t type, uint8_t* pl, size_t length) {
    IPAddress ip;
    {{ defineVariable('String', 'ip_s', '') }}
    {{ defineVariable('char_nq', 'payload', '(char *) pl') }}
    {% if global['isWS'] %}
    {{ defineVariable('String', 'resp', '') }}
    {% endif %}

    switch(type) {
        case WStype_DISCONNECTED: {
            {% if template['numevents'] > 0 and global['isWS'] %}
            {{ defineVariable('bool', 'deleted', 'false') }}
            {% endif %}
            Serial.printf("\n%d", num);
            Serial.println(" -> Disconnected");

            {% if template['numevents'] > 0 %}
            // remove all client subscriptions
            for(i=0; i<ipe_arr.size(); i++)
                if(ipe_arr[i]["num"] == num) {
                    {% if template['numevents'] > 0 and global['isWS'] %}
                    {{ setVariable(False, 'deleted', 'true') }}
                    {% endif %}
                    {{ setVariable(False, 'serializeJson(ipe_arr[i]["ip"], ip_s)') }}
                    {{ setVariable(False, 'ip_s.replace("\\"", "")') }}
                    {{ setVariable(False, 'ipe_arr.remove(i)') }}
                    {{ setVariable(False, 'ipe_doc.remove(ip_s)') }}
                    {{ setVariable(False, 'e_doc.remove(ip_s)') }}
                    break;
                }
            {% endif %}
            {% if template['numevents'] > 0 and global['isWS'] %}    
            
            if(!deleted)
                // remove all client requests
                for(i=0; i<ipia_arr.size(); i++)
                    if(ipia_arr[i]["num"] == num) {
                        {{ setVariable(True, 'ip_s', '') }}
                        {{ setVariable(False, 'serializeJson(ipia_arr[i]["ip"], ip_s)') }}
                        {{ setVariable(False, 'ip_s.replace("\\"", "")') }}
                        {{ setVariable(False, 'ipia_arr.remove(i)') }}
                        {{ setVariable(False, 'ipia_doc.remove(ip_s)') }}
                        {{ setVariable(False, 'ia_doc.remove(ip_s)') }}
                        break;
                    }     
            {% elif template['numevents'] == 0 %}  
            // remove all client requests
            for(i=0; i<ipia_arr.size(); i++)
                if(ipia_arr[i]["num"] == num) {
                    {{ setVariable(False, 'serializeJson(ipia_arr[i]["ip"], ip_s)') }}
                    {{ setVariable(False, 'ip_s.replace("\\"", "")') }}
                    {{ setVariable(False, 'ipia_arr.remove(i)') }}
                    {{ setVariable(False, 'ipia_doc.remove(ip_s)') }}
                    {{ setVariable(False, 'ia_doc.remove(ip_s)') }}
                    break;
                }   
            {% endif %}    

            {% if template['numevents'] > 0 %}
            {{ setVariable(False, 'serializeJson(e_doc, Serial)') }}
            Serial.println();
            {{ setVariable(False, 'serializeJson(ipe_doc, Serial)') }}
            Serial.println();
            {% endif %}
            {% if global['isWS'] %}
            {{ setVariable(False, 'serializeJson(ia_doc, Serial)') }}
            Serial.println();
            {{ setVariable(False, 'serializeJson(ipia_doc, Serial)') }}
            Serial.println();
            {% endif %}
        }
        break;

        case WStype_CONNECTED: {
            {{ defineVariable('bool', 'done', 'false') }}
            {{ defineVariable('bool', 'conn', 'false') }}
            {% if template['numevents'] > 0 %}
            JsonObject obj_e;
            JsonObject obj_ipe;
            {% endif %}
            {% if global['isWS'] %}
            JsonObject obj_ia;
            JsonObject obj_ipia;
            {{ defineVariable('bool', 'parsingDone', 'false') }}
            {% endif %}

            {{ setVariable(False, 'ip', 'webSocket.remoteIP(num)') }}
            {{ setVariable(False, 'ip_s', 'ip.toString()') }}
            Serial.printf("\n%d", num);
            Serial.print(" -> Connection request from ");
            Serial.println(ip);
            Serial.printf("Payload: %s\n", payload);

            {% if template['numevents'] > 0 %}
            {{ setVariable(False, 'i', '0') }}
            while(!done && i<events_number) {
                if(events_endpoint[i].equals(payload)) {
                    if(e_doc[ip_s].isNull()) {
                        {{ setVariable(False, 'obj_e', 'e_doc.createNestedArray(ip_s).createNestedObject()') }}
                        {{ setVariable(False, 'obj_ipe', 'ipe_arr.createNestedObject()') }}
                        {{ setVariable(False, 'obj_ipe["ip"]', 'ip_s') }}
                        {{ setVariable(False, 'obj_ipe["num"]', 'num') }}
                        {{ setVariable(False, 'ipe_doc[ip_s]', 'num') }}
                    }
                    else {
                        {{ setVariable(False, 'j', '0') }}
                        while(!conn && j<e_doc[ip_s].size()) {
                            if(!e_doc[ip_s][j][events_list[i]].isNull())
                                {{ setVariable(False, 'conn', 'true') }}
                            {{ setVariable(False, 'j++') }}    
                        }
                        if(!conn)
                            {{ setVariable(False, 'obj_e', 'e_doc[ip_s].createNestedObject()') }}  
                    }
                    
                    if(conn) {
                        {{ setVariable(False, 'done', 'true') }}
                        webSocket.sendTXT(num, "Connection already established");
                    }
                    else {
                        {{ setVariable(False, 'done', 'true') }}
                        webSocket.sendTXT(num, "Connection confirmed");
                        if(events_subscriptionSchema[i]) 
                            {{ setVariable(False, 'obj_e[events_list[i]]', 'false') }}
                        else {
                            {{ setVariable(False, 'obj_e[events_list[i]]', 'true') }}  
                            webSocket.sendTXT(num, "Subscription confirmed");  
                        }
                    }
                }
                {{ setVariable(False, 'i++') }}
            }
            {% endif %}
            {% if template['numevents'] > 0 and global['isWS'] %}
            
            if(!done) {
                {{ setVariable(False, 'i', '0') }}
                while(!done && i<ws_requestsNumber) {
                    if(ws_endpoint[i].equals(payload)) {
                        if(ia_doc[ip_s].isNull()) {
                            {{ setVariable(False, 'obj_ia', 'ia_doc.createNestedArray(ip_s).createNestedObject()') }}
                            {{ setVariable(False, 'obj_ipia', 'ipia_arr.createNestedObject()') }}
                            {{ setVariable(False, 'obj_ipia["ip"]', 'ip_s') }}
                            {{ setVariable(False, 'obj_ipia["num"]', 'num') }}
                            {{ setVariable(False, 'ipia_doc[ip_s]', 'num') }}
                        }
                        else {
                            {{ setVariable(False, 'j', '0') }}
                            while(!conn && j<ia_doc[ip_s].size()) {
                                if(!ia_doc[ip_s][j][ws_requests[i]].isNull())
                                    {{ setVariable(False, 'conn', 'true') }}
                                {{ setVariable(False, 'j++') }}    
                            }
                            if(!conn)
                                {{ setVariable(False, 'obj_ia', 'ia_doc[ip_s].createNestedObject()') }}  
                        }
                        
                        if(conn) {
                            {{ setVariable(False, 'done', 'true') }}
                            webSocket.sendTXT(num, "Connection already established");
                        }
                        else {
                            {% if capacity['actions'] > 0 %}
                            // verify if the endpoint of this connection request refers to an Action
                            {{ defineVariable('bool', 'isAction', 'false') }}
                            {{ setVariable(False, 'j', '0') }}
                            while(!done && j<ws_actionsNumber) {
                                if(ws_requests[i].equals(ws_actions[j])) {
                                    {{ setVariable(False, 'done', 'true') }}
                                    {{ setVariable(False, 'isAction', 'true') }}
                                    webSocket.sendTXT(num, "Connection confirmed");
                                    {{ setVariable(False, 'k', '0') }}
                                    while(!parsingDone && k<ws_actionsNumber) {
                                        switch(k) {
                                            {% for i in range(0, capacity['actions']) %}
                                            case {{ i }}: {
                                                if(k == j) {
                                                    if(action{{ i+1 }}_inputsNumber == 0) {
                                                        {{ setVariable(False, 'parsingDone', 'true') }}
                                                        {{ setVariable(False, 'obj_ia[ws_requests[i]]', 'true') }} 
                                                        {{ setVariable(False, 'resp', 'request' + (i+1+3+template['numproperties']) | string + '("{}")') }}
                                                        webSocket.sendTXT(num, resp);
                                                    }
                                                }
                                            }
                                            break;

                                            {% endfor %}
                                        }
                                        {{ setVariable(False, 'k++') }}
                                    }
                                    if(!parsingDone)
                                        {{ setVariable(False, 'obj_ia[ws_requests[i]]', 'false') }}
                                }
                                {{ setVariable(False, 'j++') }}
                            }

                            if(!isAction) {
                                {{ setVariable(False, 'done', 'true') }}
                                {{ setVariable(False, 'obj_ia[ws_requests[i]]', 'true') }}  
                                
                                {% for elem in reqPropertyWS %}
                                {% if loop.first %}
                                if(ws_requests[i].equals({{ elem[0] }}))
                                    {{ setVariable(False, 'resp', 'request' + elem[1] | string + '()') }}
                                {% else %}
                                else if(ws_requests[i].equals({{ elem[0] }}))
                                    {{ setVariable(False, 'resp', 'request' + elem[1] | string + '()') }}
                                {% endif %}
                                {% endfor %}

                                webSocket.sendTXT(num, resp);  
                            }
                            {% else %}
                            {{ setVariable(False, 'done', 'true') }}
                            {{ setVariable(False, 'obj_ia[ws_requests[i]]', 'true') }}  
                            
                            {% for elem in reqPropertyWS %}
                            {% if loop.first %}
                            if(ws_requests[i].equals({{ elem[0] }}))
                                {{ setVariable(False, 'resp', 'request' + elem[1] | string + '()') }}
                            {% else %}
                            else if(ws_requests[i].equals({{ elem[0] }}))
                                {{ setVariable(False, 'resp', 'request' + elem[1] | string + '()') }}
                            {% endif %}
                            {% endfor %}    

                            webSocket.sendTXT(num, resp);  
                            {% endif %}
                        }
                    }
                    {{ setVariable(False, 'i++') }}
                }
            }
            {% elif template['numevents'] == 0 %}

            {{ setVariable(False, 'i', '0') }}
            while(!done && i<ws_requestsNumber) {
                if(ws_endpoint[i].equals(payload)) {
                    if(ia_doc[ip_s].isNull()) {
                        {{ setVariable(False, 'obj_ia', 'ia_doc.createNestedArray(ip_s).createNestedObject()') }}
                        {{ setVariable(False, 'obj_ipia', 'ipia_arr.createNestedObject()') }}
                        {{ setVariable(False, 'obj_ipia["ip"]', 'ip_s') }}
                        {{ setVariable(False, 'obj_ipia["num"]', 'num') }}
                        {{ setVariable(False, 'ipia_doc[ip_s]', 'num') }}
                    }
                    else {
                        {{ setVariable(False, 'j', '0') }}
                        while(!conn && j<ia_doc[ip_s].size()) {
                            if(!ia_doc[ip_s][j][ws_requests[i]].isNull())
                                {{ setVariable(False, 'conn', 'true') }}
                            {{ setVariable(False, 'j++') }}    
                        }
                        if(!conn)
                            {{ setVariable(False, 'obj_ia', 'ia_doc[ip_s].createNestedObject()') }}  
                    }
                    
                    if(conn) {
                        {{ setVariable(False, 'done', 'true') }}
                        webSocket.sendTXT(num, "Connection already established");
                    }
                    else {
                        {% if capacity['actions'] > 0 %}
                        // verify if the endpoint of this connection request refers to an Action
                        {{ defineVariable('bool', 'isAction', 'false') }}
                        {{ setVariable(False, 'j', '0') }}
                        while(!done && j<ws_actionsNumber) {
                            if(ws_requests[i].equals(ws_actions[j])) {
                                {{ setVariable(False, 'done', 'true') }}
                                {{ setVariable(False, 'isAction', 'true') }}
                                webSocket.sendTXT(num, "Connection confirmed");
                                {{ setVariable(False, 'k', '0') }}
                                while(!parsingDone && k<ws_actionsNumber) {
                                    switch(k) {
                                        {% for i in range(0, capacity['actions']) %}
                                        case {{ i }}: {
                                            if(k == j) {
                                                if(action{{ i+1 }}_inputsNumber == 0) {
                                                    {{ setVariable(False, 'parsingDone', 'true') }}
                                                    {{ setVariable(False, 'obj_ia[ws_requests[i]]', 'true') }} 
                                                    {{ setVariable(False, 'resp', 'request' + (i+1+3+template['numproperties']) | string + '("{}")') }}
                                                    webSocket.sendTXT(num, resp);
                                                }
                                            }
                                        }
                                        break;

                                        {% endfor %}
                                    }
                                    {{ setVariable(False, 'k++') }}
                                }
                                if(!parsingDone)
                                    {{ setVariable(False, 'obj_ia[ws_requests[i]]', 'false') }}
                            }
                            {{ setVariable(False, 'j++') }}
                        }

                        if(!isAction) {
                            {{ setVariable(False, 'done', 'true') }}
                            {{ setVariable(False, 'obj_ia[ws_requests[i]]', 'true') }}  
                            
                            {% for elem in reqPropertyWS %}
                            {% if loop.first %}
                            if(ws_requests[i].equals({{ elem[0] }}))
                                {{ setVariable(False, 'resp', 'request' + elem[1] | string + '()') }}
                            {% else %}
                            else if(ws_requests[i].equals({{ elem[0] }}))
                                {{ setVariable(False, 'resp', 'request' + elem[1] | string + '()') }}
                            {% endif %}
                            {% endfor %}

                            webSocket.sendTXT(num, resp);  
                        }
                        {% else %}
                        {{ setVariable(False, 'done', 'true') }}
                        {{ setVariable(False, 'obj_ia[ws_requests[i]]', 'true') }}  
                        
                        {% for elem in reqPropertyWS %}
                        {% if loop.first %}
                        if(ws_requests[i].equals({{ elem[0] }}))
                            {{ setVariable(False, 'resp', 'request' + elem[1] | string + '()') }}
                        {% else %}
                        else if(ws_requests[i].equals({{ elem[0] }}))
                            {{ setVariable(False, 'resp', 'request' + elem[1] | string + '()') }}
                        {% endif %}
                        {% endfor %}

                        webSocket.sendTXT(num, resp);  
                        {% endif %}
                    }
                }
                {{ setVariable(False, 'i++') }}
            }
            {% else %}

            if(!done)
                webSocket.sendTXT(num, "Connection refused"); 
            {% endif %}

            {% if template['numevents'] > 0 %}
            {{ setVariable(False, 'serializeJson(e_doc, Serial)') }}
            Serial.println();
            {{ setVariable(False, 'serializeJson(ipe_doc, Serial)') }}
            Serial.println();
            {% endif %}
            {% if global['isWS'] %}
            {{ setVariable(False, 'serializeJson(ia_doc, Serial)') }}
            Serial.println();
            {{ setVariable(False, 'serializeJson(ipia_doc, Serial)') }}
            Serial.println();
            {% endif %}
        }
        break;

        case WStype_TEXT:
        { 
            {% if template['numevents'] > 0 and global['isWS'] %}
            {% if capacity['maxSchema'] * 2 > capacity['maxInputSchema'] %}
            DynamicJsonDocument resp_doc({{ capacity['maxSchema'] * 2}});
            {% else %}
            DynamicJsonDocument resp_doc({{ capacity['maxInputSchema'] }});
            {% endif %}
            {% elif template['numevents'] > 0 %}
            DynamicJsonDocument resp_doc({{ capacity['maxSchema'] * 2}});
            {% else %}
            DynamicJsonDocument resp_doc({{ capacity['maxInputSchema'] }});
            {% endif %}
            {% if template['numevents'] > 0 %}
            {{ defineVariable('bool', 'parsingDone', 'false') }}
            {{ defineVariable('int', 'validInput', '0') }}
            {{ defineVariable('String', 't_name', 'iv') }}
            {{ defineVariable('String', 'validate', 'iv') }}
            {{ defineVariable('String', 'message', 'iv') }}
            {% else %}
            {{ defineVariable('bool', 'parsingDone', 'false') }}
            {% endif %}

            {{ setVariable(False, 'ip', 'webSocket.remoteIP(num)') }}
            {{ setVariable(False, 'ip_s', 'ip.toString()') }}
            Serial.printf("\n%d", num);
            Serial.print(" -> Get Text from ");
            Serial.println(ip);
            Serial.printf("Payload: %s\n", payload);

            {{ setVariable(False, 'err', 'deserializeJson(resp_doc, payload)') }}
            if(err) {
                Serial.printf("deserializeJson() failed with code %s", err.c_str());
                webSocket.sendTXT(num, "deserializeJson failed");
            }
            else {
                {% if template['numevents'] > 0 %}
                {{ defineVariable('String', 'message', 'iv') }}
                {{ setVariable(False, 'serializeJson(resp_doc, message)') }}
                {{ setVariable(False, 'i', '0') }}
                while(!parsingDone && i<e_doc[ip_s].size()) {
                    {{ setVariable(False, 'j', '0') }}
                    while(!parsingDone && j<events_number) {
                        if(!e_doc[ip_s][i][events_list[j]].isNull()) {
                            if(!e_doc[ip_s][i][events_list[j]] && events_subscriptionSchema[j]) {
                                DynamicJsonDocument tmp_doc({{ capacity['maxSchema'] * 2 }});
                                {{ defineVariable('JsonObject', 'tmp', 'tmp_doc.createNestedObject()') }}
                                {{ setVariable(False, 'validInput', '0') }}
                                {{ setVariable(False, 'k', '0') }}
                                while(!parsingDone && k<es_doc[events_list[j]]["subscription"].size()) {
                                    {{ setVariable(True, 't_name', '') }}
                                    {{ setVariable(False, 'serializeJson(es_doc[events_list[j]]["subscription"][k]["name"], t_name)') }}
                                    {{ setVariable(False, 't_name.replace("\\"", "")') }}
                                    if(!resp_doc[t_name].isNull()) {
                                        {{ setVariable(False, 'tmp[t_name]', 'es_doc[events_list[j]]["subscription"][k]["value"]') }}
                                        {{ setVariable(False, 'validInput++') }}
                                    }
                                    else  
                                        {{ setVariable(False, 'parsingDone', 'false') }}
                                    {{ setVariable(False, 'k++') }}
                                }
                                if(validInput == k) {
                                    {{ setVariable(False, 'parsingDone', 'true') }}
                                    {{ setVariable(True, 'validate', '') }}
                                    {{ setVariable(False, 'serializeJson(tmp, validate)') }}
                                    if(validate.equals(message)) {
                                        {{ setVariable(False, 'e_doc[ip_s][i][events_list[j]]', 'true') }}
                                        webSocket.sendTXT(num, "Subscription confirmed");
                                    }
                                    else 
                                        webSocket.sendTXT(num, "Subscription refused");
                                }
                            }
                            else if(e_doc[ip_s][i][events_list[j]] && events_cancellationSchema[j]) {
                                DynamicJsonDocument tmp_doc({{ capacity['maxSchema'] * 2 }});
                                {{ defineVariable('JsonObject', 'tmp', 'tmp_doc.createNestedObject()') }}
                                {{ setVariable(False, 'validInput', '0') }}
                                {{ setVariable(False, 'k', '0') }}
                                while(!parsingDone && k<es_doc[events_list[j]]["cancellation"].size()) {
                                    {{ setVariable(True, 't_name', '') }}
                                    {{ setVariable(False, 'serializeJson(es_doc[events_list[j]]["cancellation"][k]["name"], t_name)') }}
                                    {{ setVariable(False, 't_name.replace("\\"", "")') }}
                                    if(!resp_doc[t_name].isNull()) {                                   
                                        {{ setVariable(False, 'tmp[t_name]', 'es_doc[events_list[j]]["cancellation"][k]["value"]') }}
                                        {{ setVariable(False, 'validInput++') }}
                                    }
                                    else
                                        {{ setVariable(False, 'parsingDone', 'false') }}
                                    {{ setVariable(False, 'k++') }}
                                }
                                if(validInput == k) {
                                    {{ setVariable(False, 'parsingDone', 'true') }}
                                    {{ setVariable(True, 'validate', '') }}
                                    {{ setVariable(False, 'serializeJson(tmp, validate)') }}
                                    if(validate.equals(message)) {
                                        {{ setVariable(False, 'e_doc[ip_s][i][events_list[j]]', 'false') }}
                                        webSocket.sendTXT(num, "Cancellation confirmed");
                                    }
                                    else
                                        webSocket.sendTXT(num, "Cancellation refused");
                                }
                            }  
                        }
                        {{ setVariable(False, 'j++') }}
                    }
                    {{ setVariable(False, 'i++') }}
                }
                {% endif %}
                {% if template['numevents'] > 0 and capacity['actions'] > 0 %}
                if(!parsingDone) {
                    {{ setVariable(False, 'i', '0') }}
                    while(!parsingDone && i<ia_doc[ip_s].size()) {
                        {{ setVariable(False, 'j', '0') }}
                        while(!parsingDone && j<ws_actionsNumber) { 
                            if(!ia_doc[ip_s][i][ws_actions[j]].isNull()) {
                                if(!ia_doc[ip_s][i][ws_actions[j]]) {
                                    {{ setVariable(False, 'k', '0') }}
                                    while(!parsingDone && k<ws_actionsNumber) {
                                        switch(k) {
                                            {% for i in range(0, capacity['actions']) %}
                                            case {{ i }}: {
                                                if(k == j) {
                                                    {{ setVariable(False, 'parsingDone', 'true') }}
                                                    {{ setVariable(False, 'ia_doc[ip_s][i][ws_actions[j]]', 'true') }}
                                                    {{ setVariable(False, 'resp', 'request' + (i+1+3+template['numproperties']) | string + '(payload)') }}
                                                    webSocket.sendTXT(num, resp);
                                                }
                                            }
                                            break;

                                            {% endfor %}
                                        }
                                        {{ setVariable(False, 'k++') }}
                                    }
                                }
                            }
                            {{ setVariable(False, 'j++') }}  
                        }        
                        {{ setVariable(False, 'i++') }} 
                    }
                }
                {% elif template['numevents'] == 0 %}
                {{ setVariable(False, 'i', '0') }}
                while(!parsingDone && i<ia_doc[ip_s].size()) {
                    {{ setVariable(False, 'j', '0') }}
                    while(!parsingDone && j<ws_actionsNumber) { 
                        if(!ia_doc[ip_s][i][ws_actions[j]].isNull()) {
                            if(!ia_doc[ip_s][i][ws_actions[j]]) {
                                {{ setVariable(False, 'k', '0') }}
                                while(!parsingDone && k<ws_actionsNumber) {
                                    switch(k) {
                                        {% for i in range(0, capacity['actions']) %}
                                        case {{ i }}: {
                                            if(k == j) {
                                                {{ setVariable(False, 'parsingDone', 'true') }}
                                                {{ setVariable(False, 'ia_doc[ip_s][i][ws_actions[j]]', 'true') }}
                                                {{ setVariable(False, 'resp', 'request' + (i+1+3+template['numproperties']) | string + '(payload)') }}
                                                webSocket.sendTXT(num, resp);
                                            }
                                        }
                                        break;

                                        {% endfor %}
                                    }
                                    {{ setVariable(False, 'k++') }}
                                }
                            }
                        }
                        {{ setVariable(False, 'j++') }}  
                    }        
                    {{ setVariable(False, 'i++') }} 
                }
                {% endif %}
                
                if(!parsingDone) 
                    webSocket.sendTXT(num, "Invalid message");
            }

            {% if template['numevents'] > 0 %}
            {{ setVariable(False, 'serializeJson(e_doc, Serial)') }}
            Serial.println();
            {{ setVariable(False, 'serializeJson(ipe_doc, Serial)') }}
            Serial.println();
            {% endif %}
            {% if capacity['actions'] > 0 %}
            {{ setVariable(False, 'serializeJson(ia_doc, Serial)') }}
            Serial.println();
            {{ setVariable(False, 'serializeJson(ipia_doc, Serial)') }}
            Serial.println();
            {% endif %}
        }
        break;
        {% for ws in template['websocket'] %}
        
        case {{ ws['type'] }}:
        {
            {{ '\t' + ws['body'] | replace('{', '\n\t\t{\n\t\t') | replace('}', '}\n\t\t') | replace(';', ';\n\t\t') }}
        }
        break;
        {% endfor %}
    }
}
{% endif %}
{% if template['functions'] | length > 0 %}
{% for fun in template['functions'] %}

{{ defineFunction(fun['name'], fun['inputs'], fun['output'], fun['body'], fun['source'], False) }}
{% endfor %}
{% endif %}